<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ íƒ„ì†Œì¤‘ë¦½ íŠ¸ë¦¬ë§µ (Final)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; overflow: hidden; }
        
        /* ì§€ë„ ì „ì²´ í™”ë©´ */
        #map { width: 100vw; height: 100vh; z-index: 1; }

        /* ì¢Œì¸¡ ìƒë‹¨ í†µê³„ íŒ¨ë„ */
        .dashboard-panel {
            position: absolute; top: 20px; left: 20px; width: 280px;
            background: rgba(20, 30, 48, 0.95);
            color: #fff; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 10;
            backdrop-filter: blur(5px);
        }
        .panel-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .stat-item { margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-end; }
        .stat-label { font-size: 13px; color: #ccc; }
        .stat-value { font-size: 24px; font-weight: bold; color: #00e676; }
        .stat-unit { font-size: 14px; color: #fff; margin-left: 2px; }

        /* ì°¨íŠ¸ ëª¨ë‹¬ (ìˆ¨ê¹€ ìƒíƒœ) */
        #chartModal {
            position: absolute; bottom: 80px; right: 20px; width: 350px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px; padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: none; z-index: 20;
        }
        .chart-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; color: #333;}
        .close-btn { cursor: pointer; color: #999; }

        /* ì°¨íŠ¸ í† ê¸€ ë²„íŠ¼ */
        .btn-chart {
            position: absolute; bottom: 20px; right: 20px; z-index: 20;
            background: #2c3e50; color: white; border: none;
            padding: 12px 20px; border-radius: 30px; font-weight: bold;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 8px;
            transition: transform 0.2s;
        }
        .btn-chart:hover { transform: scale(1.05); background: #34495e; }

        /* ì¸í¬ìœˆë„ìš° & ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
        .iw-container { padding: 5px; width: 220px; font-family: 'Noto Sans KR', sans-serif; }
        .iw-header { font-size: 14px; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 8px; color: #333; display: flex; justify-content: space-between; align-items: center; }
        .iw-status { font-size: 11px; padding: 2px 6px; border-radius: 4px; color: #fff; }
        .iw-row { display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 4px; }
        .iw-carbon-box { margin-top: 10px; background-color: #e8f5e9; padding: 8px; border-radius: 6px; text-align: center; }
        .iw-carbon-label { font-size: 11px; color: #2e7d32; margin-bottom: 2px; }
        .iw-carbon-value { font-size: 16px; font-weight: 800; color: #00c853; }

        /* ë‘¥ê·¼ ë‚˜ë¬´ ì‚¬ì§„ ë§ˆì»¤ */
        .tree-photo-marker {
            width: 55px; height: 55px;
            border-radius: 50%;
            border: 3px solid #fff;
            background-size: cover; background-position: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
            cursor: pointer; transition: transform 0.2s;
        }
        .tree-photo-marker:hover { transform: scale(1.15); border-color: #00e676; z-index: 999; }

        /* êµ¬ì—­ ì˜¤ë²„ë ˆì´ */
        .zone-overlay { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.2); min-width: 200px; position: relative; bottom: 10px; }
        .zone-title { margin: 0 0 10px 0; color: #333; font-size: 15px; font-weight: bold; border-bottom: 2px solid #00c853; padding-bottom: 5px; }
        .zone-stats { font-size: 12px; color: #555; }
        .zone-stat-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dashed #eee; padding-bottom: 2px; }
        .zone-total { margin-top: 10px; padding-top: 8px; border-top: 1px solid #ddd; font-weight: bold; color: #004c80; text-align: right; }

		/* ğŸ“± ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            /* íŒ¨ë„ ë„ˆë¹„ ì¡°ì • ë° í•˜ë‹¨ ì´ë™ */
            .dashboard-panel {
                width: auto;
                left: 10px; right: 10px; /* ì¢Œìš° ì—¬ë°± */
                top: 10px;
                padding: 15px;
            }
            
            /* í°íŠ¸ ì‚¬ì´ì¦ˆ ì¡°ì ˆ */
            .stat-value { font-size: 20px; }
            .panel-title { font-size: 16px; margin-bottom: 10px; }
            .stat-item { margin-bottom: 8px; }

            /* ì°¨íŠ¸ ëª¨ë‹¬ ë°˜ì‘í˜• */
            #chartModal {
                width: auto;
                left: 10px; right: 10px;
                bottom: 10px;
            }
            
            /* ì°¨íŠ¸ ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
            .btn-chart {
                bottom: 80px; /* ëª¨ë‹¬ ê²¹ì¹¨ ë°©ì§€ */
                right: 10px;
                padding: 10px 15px;
                font-size: 14px;
            }
            
            /* ì§€ì ë„ ë²„íŠ¼ ì¡°ì • */
            div[style*="position:absolute; top:10px; right:120px;"] {
                top: 70px !important; /* íŒ¨ë„ ì•„ë˜ë¡œ ì´ë™ */
                right: 10px !important;
            }
        }
    </style>
</head>
<body>

    <div class="dashboard-panel">
        <div class="panel-title" onclick="togglePanel()" style="cursor:pointer; display:flex; justify-content:space-between;">
          <span>ğŸŒ³ ìŠ¤ë§ˆíŠ¸ íƒ„ì†Œ ê´€ì œ</span>
          <span id="panelToggleBtn">ğŸ”¼</span>
        </div>
		<div id="panelContent">
         <div class="stat-item">
            <span class="stat-label">ê´€ë¦¬ ì¤‘ì¸ ìˆ˜ëª©</span>
            <div><span id="stat-tree-count" class="stat-value">0</span> <span class="stat-unit">ê·¸ë£¨</span></div>
         </div>
         <div class="stat-item">
            <span class="stat-label">ì—°ê°„ íƒ„ì†Œ í¡ìˆ˜</span>
            <div><span id="stat-carbon" class="stat-value">0</span> <span class="stat-unit">kg</span></div>
         </div>
         <div class="stat-item">
            <span class="stat-label">ìŠ¹ìš©ì°¨ ìƒì‡„</span>
            <div><span id="stat-cars" class="stat-value" style="color:#29b6f6;">0</span> <span class="stat-unit">ëŒ€</span></div>
         </div>
		</div>
    </div>

    <button class="btn-chart" onclick="toggleChart()">
        ğŸ“Š í†µê³„ ë¶„ì„
    </button>

    <div id="chartModal">
        <div class="chart-header">
            <span>ìˆ˜ì¢…ë³„ ë¶„ì„</span>
            <span class="close-btn" onclick="toggleChart()">âœ–</span>
        </div>
        <canvas id="speciesChart" height="200"></canvas>
        <div style="margin-top:20px;"></div>
        <canvas id="carbonChart" height="200"></canvas>
    </div>

    <div id="map"></div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=257fdd3647dd6abdb05eae8681106514&libraries=clusterer,services"></script>

    <script>
    var mapContainer = document.getElementById('map');
    var mapOption = { 
        center: new kakao.maps.LatLng(34.8118, 126.4057), // ëª©í¬ ì¤‘ì‹¬
        level: 3 
    };
    var map = new kakao.maps.Map(mapContainer, mapOption);
    
    // ì¤Œ/íƒ€ì… ì»¨íŠ¸ë¡¤
    map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
    map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);

    // ì§€ì ë„ ë²„íŠ¼
    var useDistrict = false;
    var btnControl = document.createElement('div');
    btnControl.style.cssText = 'position:absolute; top:10px; right:120px; z-index:20;';
    btnControl.innerHTML = `<button onclick="toggleCadastral()" style="background:#fff; border:1px solid #ccc; padding:6px 10px; border-radius:4px; font-weight:bold; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.2);">ğŸ”² ì§€ì ë„</button>`;
    document.body.appendChild(btnControl);

    function toggleCadastral() {
        useDistrict = !useDistrict;
        if (useDistrict) map.addOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT);
        else map.removeOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT);
    }

    const speciesName = { 'pine': 'ì†Œë‚˜ë¬´', 'zelkova': 'ëŠí‹°ë‚˜ë¬´', 'ginkgo': 'ì€í–‰ë‚˜ë¬´', 'cherry': 'ë²šë‚˜ë¬´', 'default': 'ê¸°íƒ€' };
    const speciesColor = { 'pine': '#2ecc71', 'zelkova': '#27ae60', 'ginkgo': '#f1c40f', 'cherry': '#e91e63', 'default': '#95a5a6' };
    
    let chartData = { species: {}, carbon: {} };

    // =========================================
    // 1. ë‚˜ë¬´ ë°ì´í„° ë¡œë“œ (í•µì‹¬ ìˆ˜ì • ë¶€ë¶„)
    // =========================================
    async function loadTreeData() {
        try {
            const response = await fetch('api_trees.php'); 
            const data = await response.json();

            if(data.stats) {
                document.getElementById('stat-tree-count').innerText = data.stats.total_trees;
                document.getElementById('stat-carbon').innerText = data.stats.total_carbon;
                document.getElementById('stat-cars').innerText = data.stats.car_equivalent;
            }

            // ì°¨íŠ¸ ì´ˆê¸°í™”
            chartData.species = { 'pine':0, 'zelkova':0, 'ginkgo':0, 'cherry':0, 'default':0 };
            chartData.carbon = { 'pine':0, 'zelkova':0, 'ginkgo':0, 'cherry':0, 'default':0 };

            // ê¸°ë³¸ ë§ˆì»¤ ì´ë¯¸ì§€ (ì‚¬ì§„ ì—†ì„ ë•Œ)
            const treeImage = new kakao.maps.MarkerImage('https://cdn-icons-png.flaticon.com/512/489/489969.png', new kakao.maps.Size(35, 35), { offset: new kakao.maps.Point(17, 35) });

            // ì¸í¬ìœˆë„ìš°ëŠ” í•˜ë‚˜ë§Œ ë§Œë“¤ì–´ì„œ ì¬ì‚¬ìš© (ì„±ëŠ¥ ìµœì í™”)
            var commonInfowindow = new kakao.maps.InfoWindow({ zIndex: 100, removable: true });

            data.features.forEach(feature => {
                var props = feature.properties;
                // [ì¤‘ìš”] ì¢Œí‘œê°€ ìœ íš¨í•œì§€ ì²´í¬
                if (!feature.geometry.coordinates || feature.geometry.coordinates.length < 2) return;
                
                var lat = feature.geometry.coordinates[1];
                var lng = feature.geometry.coordinates[0];
                var markerPosition = new kakao.maps.LatLng(lat, lng);

                // í†µê³„ ì§‘ê³„
                let sp = props.species;
                if(!chartData.species.hasOwnProperty(sp)) sp = 'default';
                chartData.species[sp] += parseInt(props.count);
                chartData.carbon[sp] += parseFloat(props.co2);

                // íŒì—… ë‚´ìš© ìƒì„±
                var statusColor = props.status === 'healthy' ? '#00c853' : '#ff3d00';
                var statusText = props.status === 'healthy' ? 'ì–‘í˜¸' : 'ê´€ë¦¬í•„ìš”';
                var spName = speciesName[props.species] || props.species;
                var countLabel = props.count > 1 ? ` <span style="font-size:12px; color:#0000ff; font-weight:bold;">(x${props.count})</span>` : '';
                
                var photoHtml = props.image_path ? 
                    `<div style="margin-bottom:8px;"><img src="${props.image_path}" style="width:100%; height:120px; object-fit:cover; border-radius:6px;"></div>` : '';

                var iwContent = `
                    <div class="iw-container">
                        ${photoHtml}
                        <div class="iw-header">
                            <span>${spName}${countLabel}</span> <span class="iw-status" style="background-color:${statusColor}">${statusText}</span>
                        </div>
                        <div class="iw-row"><span>ìˆ˜ëŸ‰</span><span style="font-weight:bold;">${props.count} ê·¸ë£¨</span></div>
						<div class="iw-row"><span>ìˆ˜ê³ </span><span>${props.height || '-'} m</span></div>
                        <div class="iw-row"><span>í‰ê³ ì§ê²½</span><span>${props.dbh} cm</span></div>

                        <div class="iw-carbon-box">
                            <div class="iw-carbon-label">ğŸŒ± ì´ ì—°ê°„ ì´ì‚°í™”íƒ„ì†Œ í¡ìˆ˜ëŸ‰</div>
                            <div class="iw-carbon-value">${Number(props.co2).toLocaleString()} kg</div>
                        </div>
                    </div>`;

                // â˜… [ë¶„ê¸°] ì‚¬ì§„ ìœ ë¬´ì— ë”°ë¼ ë§ˆì»¤ ìƒì„± ë°©ì‹ ë‹¤ë¦„
                if (props.image_path) {
                    // [ì‚¬ì§„ ë§ˆì»¤] CustomOverlay ì‚¬ìš©
                    var content = document.createElement('div');
                    content.className = 'tree-photo-marker';
                    content.style.backgroundImage = `url('${props.image_path}')`;
                    content.title = spName; // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì´ë¦„

                    var customOverlay = new kakao.maps.CustomOverlay({
                        position: markerPosition,
                        content: content,
                        map: map,
                        yAnchor: 0.5 // ì¤‘ì•™ ê¸°ì¤€
                    });

                    // â˜… [ë²„ê·¸ ìˆ˜ì •] ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ì¸í¬ìœˆë„ìš° ìœ„ì¹˜ë¥¼ ê°•ì œë¡œ ì§€ì •
                    content.addEventListener('click', function() {
                        commonInfowindow.setContent(iwContent);
                        commonInfowindow.setPosition(markerPosition); // ìœ„ì¹˜ ì§ì ‘ ì§€ì • (í•„ìˆ˜!)
                        commonInfowindow.open(map); // ë§ˆì»¤ ê°ì²´ ì—†ì´ ë§µì— ì§ì ‘ ì˜¤í”ˆ
                    });

                } else {
                    // [ê¸°ë³¸ ë§ˆì»¤] Marker ì‚¬ìš©
                    var marker = new kakao.maps.Marker({
                        position: markerPosition,
                        map: map,
                        image: treeImage,
                        title: spName
                    });

                    kakao.maps.event.addListener(marker, 'click', function() {
                        commonInfowindow.setContent(iwContent);
                        commonInfowindow.open(map, marker); // ê¸°ë³¸ ë§ˆì»¤ëŠ” ì•µì»¤ë§ ê°€ëŠ¥
                    });
                }
            });

            updateCharts(); 

        } catch (error) { console.error('Data Load Error:', error); }
    }

    // =========================================
    // 2. êµ¬ì—­ ë°ì´í„° ë¡œë“œ (ë³€ê²½ ì—†ìŒ, ì•ˆì •í™”)
    // =========================================
    async function loadZoneData() {
        try {
            const response = await fetch('api_zones.php');
            const zones = await response.json();
            
            // ì¸í¬ìœˆë„ìš°/ì˜¤ë²„ë ˆì´ ê´€ë¦¬ìš© ë³€ìˆ˜
            var activeOverlay = null;

            zones.forEach(zone => {
                var geoType = zone.geometry.type;
                var coords = zone.geometry.coordinates;
                var props = zone.properties;
                var overlayPos;

                // ë„í˜• ê·¸ë¦¬ê¸°
                var overlayObj; // í´ë¦¬ê³¤ì´ë‚˜ ë¼ì¸ ê°ì²´

                if (geoType === 'Polygon') {
                    var path = coords[0].map(c => new kakao.maps.LatLng(c[1], c[0]));
                    overlayObj = new kakao.maps.Polygon({
                        map: map, path: path, strokeWeight: 2, strokeColor: '#004c80',
                        fillColor: '#00c853', fillOpacity: 0.2
                    });
                    overlayPos = path[0];
                } else if (geoType === 'LineString') {
                    var path = coords.map(c => new kakao.maps.LatLng(c[1], c[0]));
                    overlayObj = new kakao.maps.Polyline({
                        map: map, path: path, strokeWeight: 8, strokeColor: '#8e44ad', strokeOpacity: 0.6
                    });
                    overlayPos = path[Math.floor(path.length/2)];
                }

                if(!overlayObj) return;

                // í†µê³„ ì˜¤ë²„ë ˆì´ ë‚´ìš©
                let statsHtml = '';
                let stats = props.stats || {};
                if (Object.keys(stats).length === 0) statsHtml = '<div style="text-align:center; color:#999;">ë°ì´í„° ì—†ìŒ</div>';
                else {
                    for (let [code, count] of Object.entries(stats)) {
                        statsHtml += `<div class="zone-stat-row"><span>${speciesName[code]||code}</span><b>${count}ì£¼</b></div>`;
                    }
                }
                var content = `<div class="zone-overlay"><div class="zone-title">ğŸ“ ${props.name}</div><div class="zone-stats">${statsHtml}</div><div class="zone-total">ì´ ${props.total_trees} ê·¸ë£¨</div></div>`;
                
                var customOverlay = new kakao.maps.CustomOverlay({
                    content: content, position: overlayPos, yAnchor: 1.2
                });

                // ì´ë²¤íŠ¸ ì—°ê²°
                kakao.maps.event.addListener(overlayObj, 'click', () => {
                    if(customOverlay.getMap()) customOverlay.setMap(null); 
                    else customOverlay.setMap(map);
                });
                kakao.maps.event.addListener(overlayObj, 'mouseover', () => { 
                    if(overlayObj.setOptions) overlayObj.setOptions({fillOpacity: 0.5, strokeOpacity: 1}); 
                });
                kakao.maps.event.addListener(overlayObj, 'mouseout', () => { 
                    if(overlayObj.setOptions) overlayObj.setOptions({fillOpacity: 0.2, strokeOpacity: 0.6}); 
                });
            });
        } catch (error) { console.error('Zone Error:', error); }
    }

    // ===================================
    // 3. ì°¨íŠ¸ ê´€ë ¨ ë¡œì§
    // ===================================
    function toggleChart() {
        var modal = document.getElementById('chartModal');
        modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
    }

    function updateCharts() {
        const ctx1 = document.getElementById('speciesChart').getContext('2d');
        new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: Object.keys(chartData.species).map(k => speciesName[k]),
                datasets: [{
                    data: Object.values(chartData.species),
                    backgroundColor: Object.keys(chartData.species).map(k => speciesColor[k])
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'right' }, title: { display: true, text: 'ìˆ˜ì¢…ë³„ ì‹ì¬ í˜„í™©' } } }
        });

        const ctx2 = document.getElementById('carbonChart').getContext('2d');
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: Object.keys(chartData.carbon).map(k => speciesName[k]),
                datasets: [{
                    label: 'íƒ„ì†Œ í¡ìˆ˜ëŸ‰ (kg)',
                    data: Object.values(chartData.carbon),
                    backgroundColor: Object.keys(chartData.carbon).map(k => speciesColor[k])
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
    }


function togglePanel() {
    var content = document.getElementById('panelContent');
    var btn = document.getElementById('panelToggleBtn');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        btn.innerText = 'ğŸ”¼';
    } else {
        content.style.display = 'none';
        btn.innerText = 'ğŸ”½';
    }
}
    // ì´ˆê¸°í™” ì‹¤í–‰
    loadTreeData();
    loadZoneData();
    
    // [ì¤‘ìš”] ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì§€ë„ ê¹¨ì§ ë°©ì§€
    window.addEventListener('resize', function() {
        map.relayout();
    });

</script>
</body>
</html>