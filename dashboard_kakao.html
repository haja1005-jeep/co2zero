<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìŠ¤ë§ˆíŠ¸ íƒ„ì†Œì¤‘ë¦½ íŠ¸ë¦¬ë§µ (Kakao)</title>
    <style>
        body { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; overflow: hidden; }
        
        /* 1. ì§€ë„ ì „ì²´ í™”ë©´ */
        #map { width: 100vw; height: 100vh; z-index: 1; }

        /* 2. ëŒ€ì‹œë³´ë“œ íŒ¨ë„ (ì¢Œì¸¡ ìƒë‹¨) - ë””ìì¸ ìœ ì§€ */
        .dashboard-panel {
            position: absolute; top: 20px; left: 20px; width: 300px;
            background: rgba(20, 30, 48, 0.9);
            color: #fff; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 10; /* ì¹´ì¹´ì˜¤ë§µ ìœ„ì— ì˜¤ë„ë¡ z-index ì¡°ì • */
            backdrop-filter: blur(5px);
        }
        .panel-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .stat-item { margin-bottom: 15px; }
        .stat-label { font-size: 12px; color: #aaa; }
        .stat-value { font-size: 24px; font-weight: bold; color: #00e676; }
        .stat-unit { font-size: 14px; color: #fff; }

        /* 3. ì¸í¬ìœˆë„ìš° ìŠ¤íƒ€ì¼ (ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´) */
        .info-window {
            background: #fff; padding: 10px; border-radius: 8px;
            border: 1px solid #ccc; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            font-size: 12px; min-width: 150px;
        }
        .info-title { font-weight: bold; color: #333; margin-bottom: 5px; font-size: 14px;}


		/* ì¸í¬ìœˆë„ìš° ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
.iw-container {
    padding: 5px;
    width: 200px;
    font-family: 'Noto Sans KR', sans-serif;
}
.iw-header {
    font-size: 14px;
    font-weight: bold;
    border-bottom: 1px solid #eee;
    padding-bottom: 8px;
    margin-bottom: 8px;
    color: #333;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.iw-status {
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 4px;
    color: #fff;
}
.iw-row {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
}
.iw-carbon-box {
    margin-top: 10px;
    background-color: #e8f5e9; /* ì—°í•œ ì´ˆë¡ ë°°ê²½ */
    padding: 8px;
    border-radius: 6px;
    text-align: center;
}
.iw-carbon-label {
    font-size: 11px;
    color: #2e7d32;
    margin-bottom: 2px;
}
.iw-carbon-value {
    font-size: 16px;
    font-weight: 800; /* ë§¤ìš° êµµê²Œ */
    color: #00c853;   /* ì§„í•œ ì´ˆë¡ìƒ‰ */
}
    </style>
</head>
<body>

    <div class="dashboard-panel">
        <div class="panel-title">ğŸŒ³ ìŠ¤ë§ˆíŠ¸ íƒ„ì†Œ ê´€ì œ (Kakao)</div>
        <div class="stat-item">
            <div class="stat-label">ê´€ë¦¬ ì¤‘ì¸ ìˆ˜ëª©</div>
            <span id="stat-tree-count" class="stat-value">0</span> <span class="stat-unit">ê·¸ë£¨</span>
        </div>
        <div class="stat-item">
            <div class="stat-label">ì‹¤ì‹œê°„ íƒ„ì†Œ í¡ìˆ˜ëŸ‰</div>
            <span id="stat-carbon" class="stat-value">0</span> <span class="stat-unit">kg/ë…„</span>
        </div>
        <div class="stat-item">
            <div class="stat-label">ìŠ¹ìš©ì°¨ ìƒì‡„ íš¨ê³¼</div>
            <span id="stat-cars" class="stat-value" style="color:#29b6f6;">0</span> <span class="stat-unit">ëŒ€ ë¶„ëŸ‰</span>
        </div>
    </div>

    <div id="map"></div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=257fdd3647dd6abdb05eae8681106514&libraries=clusterer,services"></script>

    <script>

	
        // 1. ì¹´ì¹´ì˜¤ ì§€ë„ ìƒì„±
        var container = document.getElementById('map');
        var options = {
            center: new kakao.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ ì‹œì²­ ì¤‘ì‹¬
            level: 3 // í™•ëŒ€ ë ˆë²¨ (ì‘ì„ìˆ˜ë¡ í™•ëŒ€)
        };
        var map = new kakao.maps.Map(container, options);

// 1. ë¸Œì´ì›”ë“œ(V-World) ì§€ì ë„ íƒ€ì¼ ë ˆì´ì–´ ì„¤ì •
// (ë¸Œì´ì›”ë“œ API í‚¤ê°€ ì—†ì–´ë„ íƒ€ì¼ ì´ë¯¸ì§€ëŠ” ë¬´ë£Œë¡œ í˜¸ì¶œ ê°€ëŠ¥í•©ë‹ˆë‹¤)
var cadastralLayer = new kakao.maps.Tileset({
    url: 'https://api.vworld.kr/req/wmts/1.0.0/ACEB012E-C384-3176-BC45-4D4CAE466B1E/LP_PA_CBND_BUBUN/{z}/{y}/{x}.png', 
    // ì£¼ì˜: ì‹¤ì œ ì„œë¹„ìŠ¤ ì‹œì—” ë³¸ì¸ì˜ V-World API Keyë¥¼ ë°œê¸‰ë°›ì•„ ë„£ëŠ” ê²ƒì´ ì•ˆì •ì ì…ë‹ˆë‹¤.
    // í…ŒìŠ¤íŠ¸ìš© ë¬´ë£Œ í‚¤(ë°ëª¨) í˜¹ì€ í‚¤ ì—†ì´ í˜¸ì¶œë˜ëŠ”ì§€ í™•ì¸ í•„ìš”.
    // ë§Œì•½ í‚¤ ì—†ì´ ì•ˆ ëœë‹¤ë©´, ì¹´ì¹´ì˜¤ë§µ ìì²´ ì§€ì ë„ ê¸°ëŠ¥ì„ ì“°ëŠ” ê²Œ ë” ì‰½ìŠµë‹ˆë‹¤.
});

// [ëŒ€ì•ˆ] ì¹´ì¹´ì˜¤ë§µ ìì²´ ì§€ì ë„ ë ˆì´ì–´ ì‚¬ìš©í•˜ê¸° (ê°€ì¥ ì‰¬ìš´ ë°©ë²•)
// ë³µì¡í•œ V-World ì—°ë™ ì—†ì´ ì¹´ì¹´ì˜¤ê°€ ì œê³µí•˜ëŠ” ì§€ì ë„ë¥¼ ë°”ë¡œ ì¼­ë‹ˆë‹¤.
function toggleCadastral() {
    // ì§€ì í¸ì§‘ë„ ë ˆì´ì–´ ì¶”ê°€/ì‚­ì œ í† ê¸€
    if (map.getMapTypeId() === kakao.maps.MapTypeId.USE_DISTRICT) {
        map.removeOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT); // ë„ê¸°
    } else {
        map.addOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT);    // ì¼œê¸°
    }
}

// 2. ì§€ë„ ìœ„ì— [ì§€ì ë„ On/Off] ë²„íŠ¼ ë§Œë“¤ê¸°
var btnControl = document.createElement('div');
btnControl.style.cssText = 'position:absolute; top:10px; right:10px; z-index:999;';
btnControl.innerHTML = `
    <button onclick="toggleCadastral()" style="
        background:#fff; border:1px solid #ccc; padding:8px 12px; 
        border-radius:4px; font-weight:bold; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.2);">
        ğŸ—ºï¸ ì§€ì ë„ ë³´ê¸°
    </button>
`;
document.body.appendChild(btnControl);





        // ì§€ë„ íƒ€ì… ì»¨íŠ¸ë¡¤ (ìŠ¤ì¹´ì´ë·°/ì¼ë°˜ì§€ë„ ì „í™˜)
        var mapTypeControl = new kakao.maps.MapTypeControl();
        map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

        // ì¤Œ ì»¨íŠ¸ë¡¤
        var zoomControl = new kakao.maps.ZoomControl();
        map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

        // 2. PHP API ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë° ë§ˆì»¤ í‘œì‹œ
        async function loadTreeData() {
            try {
                // ì•ì„œ ë§Œë“  PHP íŒŒì¼ í˜¸ì¶œ
                const response = await fetch('api_trees.php'); 
                const data = await response.json();

                // 2-1. ëŒ€ì‹œë³´ë“œ ìˆ«ì ì—…ë°ì´íŠ¸
                document.getElementById('stat-tree-count').innerText = data.stats.total_trees;
                document.getElementById('stat-carbon').innerText = data.stats.total_carbon;
                document.getElementById('stat-cars').innerText = data.stats.car_equivalent;

                // 2-2. ë§ˆì»¤ ìƒì„± ë° í‘œì‹œ
                data.features.forEach(feature => {
                    // GeoJSON ì¢Œí‘œëŠ” [ê²½ë„, ìœ„ë„] ìˆœì„œ
                    var lat = feature.geometry.coordinates[1];
                    var lng = feature.geometry.coordinates[0];
                    var props = feature.properties;

                    // ë§ˆì»¤ ì´ë¯¸ì§€ ì»¤ìŠ¤í…€ (ìƒíƒœì— ë”°ë¼ ë‹¤ë¥¸ ì´ë¯¸ì§€ ì‚¬ìš© ê°€ëŠ¥)
                    // ì—¬ê¸°ì„œëŠ” ê¸°ë³¸ ë§ˆì»¤ë¥¼ ì‚¬ìš©í•˜ë˜, í•„ìš”ì‹œ markerImage ì˜µì…˜ ì‚¬ìš©
                    var markerPosition  = new kakao.maps.LatLng(lat, lng); 
                    var marker = new kakao.maps.Marker({
                        position: markerPosition
                    });

                    marker.setMap(map); // ì§€ë„ì— ì˜¬ë¦¬ê¸°



// 2-3. ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸ (ì¸í¬ìœˆë„ìš°) ìˆ˜ì • ë¶€ë¶„
var statusColor = props.status === 'healthy' ? '#00c853' : '#ff3d00';
var statusText = props.status === 'healthy' ? 'ì–‘í˜¸' : 'ê´€ë¦¬í•„ìš”';

// HTML ë¬¸ìì—´ ìƒì„± (ë°±í‹± `` ì‚¬ìš©)
var iwContent = `
    <div class="iw-container">
        <div class="iw-header">
            <span>ğŸŒ² ${props.species}</span>
            <span class="iw-status" style="background-color:${statusColor}">${statusText}</span>
        </div>

        <div class="iw-row">
            <span>í‰ê³ ì§ê²½</span>
            <span>${props.dbh} cm</span>
        </div>
        <div class="iw-row">
            <span>ìˆ˜ê³ (í‚¤)</span>
            <span>${props.height || '-'} m</span>
        </div>

        <div class="iw-carbon-box">
            <div class="iw-carbon-label">ğŸŒ± ì—°ê°„ ì´ì‚°í™”íƒ„ì†Œ í¡ìˆ˜ëŸ‰</div>
            <div class="iw-carbon-value">${props.co2} kg</div>
        </div>
    </div>
`;

// ì¸í¬ìœˆë„ìš° ìƒì„± ì‹œ padding ì˜µì…˜ ì œê±° (CSSë¡œ ì œì–´í•˜ê¸° ìœ„í•´)
var infowindow = new kakao.maps.InfoWindow({
    content : iwContent,
    removable : true
});

kakao.maps.event.addListener(marker, 'click', function() {
    infowindow.open(map, marker);
});


                });

            } catch (error) {
                console.error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
            }
        }




// ìˆ˜ì¢…ë³„ í•œê¸€ ì´ë¦„ ë§¤í•‘
const speciesName = {
    'pine': 'ğŸŒ² ì†Œë‚˜ë¬´',
    'zelkova': 'ğŸŒ³ ëŠí‹°ë‚˜ë¬´',
    'ginkgo': 'ğŸ‚ ì€í–‰ë‚˜ë¬´',
    'cherry': 'ğŸŒ¸ ë²šë‚˜ë¬´',
    'default': 'ğŸŒ± ê¸°íƒ€'
};

async function loadZoneData() {
    try {
        const response = await fetch('api_zones.php');
        const zones = await response.json();

        zones.forEach(zone => {
            // 1. í´ë¦¬ê³¤ ê²½ë¡œ(Path) ë³€í™˜ (GeoJSON -> Kakao LatLng)
            // GeoJSON Polygonì€ [[[lng, lat], ...]] 3ì¤‘ ë°°ì—´ êµ¬ì¡°ì„
            var path = zone.geometry.coordinates[0].map(coord => {
                return new kakao.maps.LatLng(coord[1], coord[0]); // [ìœ„ë„, ê²½ë„] ìˆœì„œ ì£¼ì˜
            });

            // 2. í´ë¦¬ê³¤ ê·¸ë¦¬ê¸°
            var polygon = new kakao.maps.Polygon({
                map: map,
                path: path, 
                strokeWeight: 2,
                strokeColor: '#004c80', // í…Œë‘ë¦¬ ìƒ‰ (ì§„í•œ íŒŒë‘)
                strokeOpacity: 0.8,
                fillColor: '#00c853',   // ì±„ìš°ê¸° ìƒ‰ (ë…¹ìƒ‰)
                fillOpacity: 0.3        // ë°˜íˆ¬ëª…
            });

            // 3. í†µê³„ ë°ì´í„° HTML ë§Œë“¤ê¸° (ë¦¬ìŠ¤íŠ¸ í˜•íƒœ)
            let statsHtml = '';
            let stats = zone.properties.stats;
            
            // "ì†Œë‚˜ë¬´: 10, ë²šë‚˜ë¬´: 20" í˜•íƒœë¡œ ë£¨í”„ ëŒë¦¬ê¸°
            for (let [code, count] of Object.entries(stats)) {
                let name = speciesName[code] || code;
                statsHtml += `
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <span>${name}</span>
                        <span style="font-weight:bold;">${count}ì£¼</span>
                    </div>`;
            }

            // 4. ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ (í´ë¦­ ì‹œ ìƒì„¸ ì •ë³´)
            var content = `
                <div style="
                    padding:15px; background:white; border-radius:8px; 
                    box-shadow:0 2px 10px rgba(0,0,0,0.3); min-width:180px;">
                    <h4 style="margin:0 0 10px 0; color:#333;">ğŸ“ ${zone.properties.name}</h4>
                    <div style="font-size:12px; color:#555; border-top:1px solid #eee; padding-top:10px;">
                        ${statsHtml}
                    </div>
                    <div style="margin-top:10px; padding-top:10px; border-top:1px dashed #ddd; font-weight:bold; color:#00c853;">
                        ì´ ìˆ˜ëª©: ${zone.properties.total_trees} ê·¸ë£¨
                    </div>
                </div>
            `;

            var overlay = new kakao.maps.CustomOverlay({
                content: content,
                map: null, // ì²˜ìŒì—” ìˆ¨ê¹€
                position: path[0] // í´ë¦¬ê³¤ì˜ ì²« ë²ˆì§¸ ì¢Œí‘œì— í‘œì‹œ
            });

            // ì´ë²¤íŠ¸: í´ë¦¬ê³¤ í´ë¦­ ì‹œ ì˜¤ë²„ë ˆì´ í‘œì‹œ/ìˆ¨ê¹€
            kakao.maps.event.addListener(polygon, 'click', function() {
                if (overlay.getMap()) {
                    overlay.setMap(null);
                } else {
                    overlay.setMap(map);
                }
            });
            
            // í˜¸ë²„ íš¨ê³¼ (ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì§„í•´ì§)
            kakao.maps.event.addListener(polygon, 'mouseover', function() {
                polygon.setOptions({fillOpacity: 0.6});
            });
            kakao.maps.event.addListener(polygon, 'mouseout', function() {
                polygon.setOptions({fillOpacity: 0.3});
            });
        });

    } catch (error) {
        console.error('êµ¬ì—­ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
    }
}

// ê¸°ì¡´ ë‚˜ë¬´ ë¡œë”© í•¨ìˆ˜ ë’¤ì— ì‹¤í–‰
loadTreeData(); 
loadZoneData(); // ì¶”ê°€ëœ í•¨ìˆ˜ ì‹¤í–‰

		
    </script>
</body>
</html>