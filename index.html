<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ íƒ„ì†Œì¤‘ë¦½ íŠ¸ë¦¬ë§µ (Kakao)</title>
    <style>
        body { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; overflow: hidden; }
        
        /* ì§€ë„ ì „ì²´ í™”ë©´ */
        #map { width: 100vw; height: 100vh; z-index: 1; }

        /* ëŒ€ì‹œë³´ë“œ íŒ¨ë„ (ì¢Œì¸¡ ìƒë‹¨) */
        .dashboard-panel {
            position: absolute; top: 20px; left: 20px; width: 280px;
            background: rgba(20, 30, 48, 0.9);
            color: #fff; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 10;
            backdrop-filter: blur(5px);
        }
        .panel-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .stat-item { margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-end; }
        .stat-label { font-size: 13px; color: #ccc; }
        .stat-value { font-size: 24px; font-weight: bold; color: #00e676; }
        .stat-unit { font-size: 14px; color: #fff; margin-left: 2px; }

        /* ì¸í¬ìœˆë„ìš° & ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
        .iw-container { padding: 5px; width: 200px; font-family: 'Noto Sans KR', sans-serif; }
        .iw-header { font-size: 14px; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 8px; color: #333; display: flex; justify-content: space-between; align-items: center; }
        .iw-status { font-size: 11px; padding: 2px 6px; border-radius: 4px; color: #fff; }
        .iw-row { display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 4px; }
        .iw-carbon-box { margin-top: 10px; background-color: #e8f5e9; padding: 8px; border-radius: 6px; text-align: center; }
        .iw-carbon-label { font-size: 11px; color: #2e7d32; margin-bottom: 2px; }
        .iw-carbon-value { font-size: 16px; font-weight: 800; color: #00c853; }

        /* êµ¬ì—­ ì •ë³´ ì˜¤ë²„ë ˆì´ */
        .zone-overlay { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.2); min-width: 200px; position: relative; bottom: 10px; }
        .zone-title { margin: 0 0 10px 0; color: #333; font-size: 15px; font-weight: bold; border-bottom: 2px solid #00c853; padding-bottom: 5px; }
        .zone-stats { font-size: 12px; color: #555; }
        .zone-stat-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dashed #eee; padding-bottom: 2px; }
        .zone-total { margin-top: 10px; padding-top: 8px; border-top: 1px solid #ddd; font-weight: bold; color: #004c80; text-align: right; }
    </style>
</head>
<body>

    <div class="dashboard-panel">
        <div class="panel-title">ğŸŒ³ ìŠ¤ë§ˆíŠ¸ íƒ„ì†Œ ê´€ì œ</div>
        <div class="stat-item">
            <span class="stat-label">ê´€ë¦¬ ì¤‘ì¸ ìˆ˜ëª©</span>
            <div><span id="stat-tree-count" class="stat-value">0</span> <span class="stat-unit">ê·¸ë£¨</span></div>
        </div>
        <div class="stat-item">
            <span class="stat-label">ì—°ê°„ íƒ„ì†Œ í¡ìˆ˜</span>
            <div><span id="stat-carbon" class="stat-value">0</span> <span class="stat-unit">kg</span></div>
        </div>
        <div class="stat-item">
            <span class="stat-label">ìŠ¹ìš©ì°¨ ìƒì‡„</span>
            <div><span id="stat-cars" class="stat-value" style="color:#29b6f6;">0</span> <span class="stat-unit">ëŒ€</span></div>
        </div>
        <div style="margin-top:20px; font-size:12px; color:#888; text-align:center;">
            * ì‹¤ì‹œê°„ ë°ì´í„° ê¸°ë°˜ (Live)
        </div>
    </div>

    <div id="map"></div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=257fdd3647dd6abdb05eae8681106514&libraries=clusterer,services"></script>

    <script>
        // 1. ì§€ë„ ì´ˆê¸°í™”
        var container = document.getElementById('map');
        var options = {
            center: new kakao.maps.LatLng(34.8118, 126.4057), // ëª©í¬ ì¤‘ì‹¬
            level: 3
        };
        var map = new kakao.maps.Map(container, options);

        // ì§€ë„ ì»¨íŠ¸ë¡¤
        var mapTypeControl = new kakao.maps.MapTypeControl();
        map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);
        var zoomControl = new kakao.maps.ZoomControl();
        map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

        // ì§€ì ë„ í† ê¸€ ë²„íŠ¼
        var useDistrict = false;
        var btnControl = document.createElement('div');
        btnControl.style.cssText = 'position:absolute; top:10px; right:120px; z-index:999;';
        btnControl.innerHTML = `
            <button onclick="toggleCadastral()" style="
                background:#fff; border:1px solid #ccc; padding:6px 10px; 
                border-radius:4px; font-weight:bold; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.2);">
                ğŸ”² ì§€ì ë„ ë³´ê¸°
            </button>
        `;
        document.body.appendChild(btnControl);

        function toggleCadastral() {
            useDistrict = !useDistrict;
            if (useDistrict) map.addOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT);
            else map.removeOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT);
        }

        // ìˆ˜ì¢…ë³„ ì´ë¦„ ë§¤í•‘
        const speciesName = {
            'pine': 'ğŸŒ² ì†Œë‚˜ë¬´', 'zelkova': 'ğŸŒ³ ëŠí‹°ë‚˜ë¬´',
            'ginkgo': 'ğŸ‚ ì€í–‰ë‚˜ë¬´', 'cherry': 'ğŸŒ¸ ë²šë‚˜ë¬´', 'default': 'ğŸŒ± ê¸°íƒ€'
        };

        // =========================================
        // 2. ë‚˜ë¬´ ë°ì´í„° ë¡œë“œ (Point)
        // =========================================
        async function loadTreeData() {
            try {
                const response = await fetch('api_trees.php'); 
                const data = await response.json();

                // í†µê³„ ì—…ë°ì´íŠ¸
                if(data.stats) {
                    document.getElementById('stat-tree-count').innerText = data.stats.total_trees;
                    document.getElementById('stat-carbon').innerText = data.stats.total_carbon;
                    document.getElementById('stat-cars').innerText = data.stats.car_equivalent;
                }

                // ë§ˆì»¤ ì•„ì´ì½˜ ì„¤ì •
                const treeImage = new kakao.maps.MarkerImage(
                    'https://cdn-icons-png.flaticon.com/512/489/489969.png',
                    new kakao.maps.Size(35, 35),
                    { offset: new kakao.maps.Point(17, 35) }
                );

                data.features.forEach(feature => {
                    var lat = feature.geometry.coordinates[1];
                    var lng = feature.geometry.coordinates[0];
                    var props = feature.properties;

                    var marker = new kakao.maps.Marker({
                        position: new kakao.maps.LatLng(lat, lng),
                        map: map,
                        image: treeImage,
                        title: props.species // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì´ë¦„ í‘œì‹œ
                    });

                    // ì¸í¬ìœˆë„ìš° ë‚´ìš©
                    var statusColor = props.status === 'healthy' ? '#00c853' : '#ff3d00';
                    var statusText = props.status === 'healthy' ? 'ì–‘í˜¸' : 'ê´€ë¦¬í•„ìš”';
                    var spName = speciesName[props.species] || props.species;

                    var iwContent = `
                        <div class="iw-container">
                            <div class="iw-header">
                                <span>${spName}</span>
                                <span class="iw-status" style="background-color:${statusColor}">${statusText}</span>
                            </div>
                            <div class="iw-row"><span>í‰ê³ ì§ê²½</span><span>${props.dbh} cm</span></div>
                            <div class="iw-row"><span>ìˆ˜ê³ </span><span>${props.height || '-'} m</span></div>
                            <div class="iw-carbon-box">
                                <div class="iw-carbon-label">ğŸŒ± ì—°ê°„ ì´ì‚°í™”íƒ„ì†Œ í¡ìˆ˜ëŸ‰</div>
                                <div class="iw-carbon-value">${props.co2} kg</div>
                            </div>
                        </div>
                    `;

                    var infowindow = new kakao.maps.InfoWindow({ content : iwContent, removable : true });
                    kakao.maps.event.addListener(marker, 'click', function() { infowindow.open(map, marker); });
                });

            } catch (error) { console.error('ë‚˜ë¬´ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error); }
        }

        // =========================================
        // 3. êµ¬ì—­ ë°ì´í„° ë¡œë“œ (Polygon & LineString)
        // =========================================
        async function loadZoneData() {
            try {
                const response = await fetch('api_zones.php');
                const zones = await response.json();

                zones.forEach(zone => {
                    var geoType = zone.geometry.type;
                    var coords = zone.geometry.coordinates;
                    var props = zone.properties;
                    var overlayPosition; // ì˜¤ë²„ë ˆì´ ë„ìš¸ ìœ„ì¹˜

                    // 3-A. ê³µì› (Polygon) ì²˜ë¦¬
                    if (geoType === 'Polygon') {
                        // Polygon ì¢Œí‘œ êµ¬ì¡°: [[[lng, lat], ...]] (ë§ ë°°ì—´)
                        var path = coords[0].map(c => new kakao.maps.LatLng(c[1], c[0]));
                        var polygon = new kakao.maps.Polygon({
                            map: map, path: path,
                            strokeWeight: 2, strokeColor: '#004c80', strokeOpacity: 0.8,
                            fillColor: '#00c853', fillOpacity: 0.2
                        });
                        overlayPosition = path[0]; // ì²« ë²ˆì§¸ ì ì„ ì˜¤ë²„ë ˆì´ ìœ„ì¹˜ë¡œ
                        addZoneEvent(polygon, props, overlayPosition);
                    } 
                    // 3-B. ê°€ë¡œìˆ˜ê¸¸ (LineString) ì²˜ë¦¬
                    else if (geoType === 'LineString') {
                        // LineString ì¢Œí‘œ êµ¬ì¡°: [[lng, lat], ...] (ì  ë°°ì—´)
                        var path = coords.map(c => new kakao.maps.LatLng(c[1], c[0]));
                        var polyline = new kakao.maps.Polyline({
                            map: map, path: path,
                            strokeWeight: 8, strokeColor: '#8e44ad', strokeOpacity: 0.6,
                            strokeStyle: 'solid'
                        });
                        overlayPosition = path[Math.floor(path.length / 2)]; // ì¤‘ê°„ ì§€ì 
                        addZoneEvent(polyline, props, overlayPosition);
                    }
                });

            } catch (error) { console.error('êµ¬ì—­ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error); }
        }

        // êµ¬ì—­ ì´ë²¤íŠ¸ ë° ì˜¤ë²„ë ˆì´ ìƒì„± í•¨ìˆ˜
        function addZoneEvent(target, props, position) {
            // í†µê³„ HTML ìƒì„±
            let statsHtml = '';
            let stats = props.stats || {};
            if (Object.keys(stats).length === 0) {
                statsHtml = '<div style="text-align:center; color:#999;">ì‹ì¬ëœ ë‚˜ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            } else {
                for (let [code, count] of Object.entries(stats)) {
                    let name = speciesName[code] || code;
                    statsHtml += `
                        <div class="zone-stat-row">
                            <span>${name}</span>
                            <span style="font-weight:bold;">${count}ì£¼</span>
                        </div>`;
                }
            }

            var content = `
                <div class="zone-overlay">
                    <div class="zone-title">ğŸ“ ${props.name}</div>
                    <div class="zone-stats">${statsHtml}</div>
                    <div class="zone-total">ì´ ${props.total_trees} ê·¸ë£¨</div>
                </div>
            `;

            var overlay = new kakao.maps.CustomOverlay({
                content: content,
                map: null,
                position: position,
                yAnchor: 1.2
            });

            // í´ë¦­ ì‹œ ì˜¤ë²„ë ˆì´ í† ê¸€
            kakao.maps.event.addListener(target, 'click', function() {
                if (overlay.getMap()) overlay.setMap(null);
                else overlay.setMap(map);
            });

            // í˜¸ë²„ íš¨ê³¼
            kakao.maps.event.addListener(target, 'mouseover', function() {
                if(target.setOptions) target.setOptions({fillOpacity: 0.5, strokeOpacity: 1}); // í´ë¦¬ê³¤
                else target.setOptions({strokeOpacity: 1, strokeWeight: 10}); // ë¼ì¸
            });
            kakao.maps.event.addListener(target, 'mouseout', function() {
                if(target.setOptions) target.setOptions({fillOpacity: 0.2, strokeOpacity: 0.8});
                else target.setOptions({strokeOpacity: 0.6, strokeWeight: 8});
            });
        }

        // ì‹¤í–‰
        loadTreeData();
        loadZoneData();

    </script>
</body>
</html>