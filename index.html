<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ íƒ„ì†Œì¤‘ë¦½ íŠ¸ë¦¬ë§µ (Final)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=257fdd3647dd6abdb05eae8681106514&libraries=services,clusterer"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; overflow: hidden; }
        #map { width: 100vw; height: 100vh; z-index: 1; }

        /* í†µê³„ íŒ¨ë„ (ë°”í…€ ì‹œíŠ¸ ìŠ¤íƒ€ì¼) */
        .dashboard-panel {
            position: absolute; top: auto; bottom: 0; left: 0; width: 100%; 
            background: rgba(20, 30, 48, 0.95); color: #fff; padding: 20px; 
            border-radius: 20px 20px 0 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.5); 
            z-index: 50; box-sizing: border-box;
        }
        .panel-title { font-size: 16px; font-weight: bold; margin-bottom: 12px; text-align: center; }
        .stat-item { margin-bottom: 8px; display: flex; justify-content: space-between; align-items: flex-end; }
        .stat-label { font-size: 13px; color: #ccc; }
        .stat-value { font-size: 22px; font-weight: bold; color: #00e676; }
        .stat-unit { font-size: 14px; color: #fff; margin-left: 2px; }

        /* ì°¨íŠ¸ ëª¨ë‹¬ */
        #chartModal {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.98); border-radius: 20px 20px 0 0; padding: 20px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3); display: none; z-index: 100; box-sizing: border-box;
        }
        .chart-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; color: #333;}
        .close-btn { cursor: pointer; font-size: 20px; color: #999; }
        .filter-status { font-size: 12px; color: #e74c3c; display: none; margin-left: 10px; }

        /* ë²„íŠ¼ë“¤ */
        .btn-chart {
            position: absolute; bottom: 190px; right: 15px; z-index: 20;
            background: #2c3e50; color: white; border: none; padding: 10px 16px; 
            border-radius: 30px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 8px; transition: transform 0.2s;
        }
        .btn-chart:hover { transform: scale(1.05); background: #34495e; }

        /* ì§€ì ë„ ë²„íŠ¼ ìœ„ì¹˜ (ëª¨ë°”ì¼ ìµœì í™”) */
        .map-custom-btn { position: absolute; top: 80px; right: 10px; z-index: 20; }

        /* ë§ˆì»¤ ë° ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
        .tree-photo-marker {
            width: 55px; height: 55px; border-radius: 50%; border: 3px solid #fff;
            background-size: cover; background-position: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.4); cursor: pointer; transition: transform 0.2s;
        }
        .tree-photo-marker:hover { transform: scale(1.15); border-color: #00e676; z-index: 999; }

        .iw-container { padding: 5px; width: 220px; }
        .iw-header { font-size: 14px; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 8px; color: #333; display: flex; justify-content: space-between; }
        .iw-status { font-size: 11px; padding: 2px 6px; border-radius: 4px; color: #fff; }
        .iw-row { display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 4px; }
        .iw-carbon-box { margin-top: 10px; background-color: #e8f5e9; padding: 8px; border-radius: 6px; text-align: center; }
        .iw-carbon-label { font-size: 11px; color: #2e7d32; }
        .iw-carbon-value { font-size: 16px; font-weight: 800; color: #00c853; }

        .zone-overlay { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.2); min-width: 200px; position: relative; bottom: 10px; }
        .zone-title { margin: 0 0 10px 0; color: #333; font-size: 15px; font-weight: bold; border-bottom: 2px solid #00c853; padding-bottom: 5px; }
        .zone-stats { font-size: 12px; color: #555; }
        .zone-stat-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dashed #eee; padding-bottom: 2px; }
        .zone-total { margin-top: 10px; padding-top: 8px; border-top: 1px solid #ddd; font-weight: bold; color: #004c80; text-align: right; }

        /* PC í™”ë©´ ëŒ€ì‘ (íŒ¨ë„ ë³µì›) */
        @media (min-width: 769px) {
            .dashboard-panel { top: 20px; bottom: auto; left: 20px; width: 280px; border-radius: 12px; }
            .btn-chart { bottom: 20px; right: 20px; }
            .map-custom-btn { top: 10px; right: 120px; }
            #chartModal { bottom: 80px; right: 20px; width: 400px; left: auto; border-radius: 12px; }
        }
    </style>
</head>
<body>

    <div class="dashboard-panel">
        <div class="panel-title">ğŸŒ³ ìŠ¤ë§ˆíŠ¸ íƒ„ì†Œ ê´€ì œ</div>
        <div class="stat-item">
            <span class="stat-label">ê´€ë¦¬ ì¤‘ì¸ ìˆ˜ëª©</span>
            <div><span id="stat-tree-count" class="stat-value">0</span> <span class="stat-unit">ê·¸ë£¨</span></div>
        </div>
        <div class="stat-item">
            <span class="stat-label">ì—°ê°„ íƒ„ì†Œ í¡ìˆ˜</span>
            <div><span id="stat-carbon" class="stat-value">0</span> <span class="stat-unit">kg</span></div>
        </div>
        <div class="stat-item">
            <span class="stat-label">ìŠ¹ìš©ì°¨ ìƒì‡„</span>
            <div><span id="stat-cars" class="stat-value" style="color:#29b6f6;">0</span> <span class="stat-unit">ëŒ€</span></div>
        </div>
    </div>

    <button class="btn-chart" onclick="toggleChart()">ğŸ“Š í†µê³„ ë¶„ì„</button>

    <div id="chartModal">
        <div class="chart-header">
            <div>ìˆ˜ì¢…ë³„ ë¶„ì„ <span id="filterStatus" class="filter-status">âš¡ í•„í„°ë§ ì¤‘</span></div>
            <span class="close-btn" onclick="toggleChart()">âœ–</span>
        </div>
        <div style="font-size:11px; color:#666; margin-bottom:10px;">* ì°¨íŠ¸ë¥¼ í´ë¦­í•˜ë©´ ì§€ë„ì—ì„œ í•´ë‹¹ ìˆ˜ì¢…ë§Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        <canvas id="speciesChart" height="200"></canvas>
        <div style="margin-top:20px;"></div>
        <canvas id="carbonChart" height="200"></canvas>
    </div>

    <div id="map"></div>

    <script>
        Chart.register(ChartDataLabels);

        var container = document.getElementById('map');
        // ì´ˆê¸° ë ˆë²¨ì€ ì˜ë¯¸ ì—†ìŒ (ë‚˜ì¤‘ì— boundsë¡œ ì¬ì„¤ì •ë¨)
        var options = { center: new kakao.maps.LatLng(34.8118, 126.4057), level: 9 }; 
        var map = new kakao.maps.Map(container, options);
        map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
        map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);

        // â˜… [í•µì‹¬ 1] ëª¨ë“  ì¢Œí‘œë¥¼ í¬í•¨í•  Bounds ê°ì²´ ìƒì„±
        var bounds = new kakao.maps.LatLngBounds();

        // â˜… [í•µì‹¬ 2] ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ëŸ¬ ìƒì„± (ì§€ì €ë¶„í•¨ ë°©ì§€)
        var clusterer = new kakao.maps.MarkerClusterer({
            map: map,
            averageCenter: true,
            minLevel: 5 // ì´ ë ˆë²¨ë³´ë‹¤ ì¤Œì¸í•˜ë©´ í´ëŸ¬ìŠ¤í„° í’€ë¦¼
        });

        // ì§€ì ë„ ë²„íŠ¼
        var useDistrict = false;
        var btnControl = document.createElement('div');
        btnControl.className = 'map-custom-btn';
        btnControl.innerHTML = `<button onclick="toggleCadastral()" style="background:#fff; border:1px solid #ccc; padding:6px 10px; border-radius:4px; font-weight:bold; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.2);">ğŸ”² ì§€ì ë„</button>`;
        document.body.appendChild(btnControl);

        function toggleCadastral() {
            useDistrict = !useDistrict;
            if (useDistrict) map.addOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT);
            else map.removeOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT);
        }

        const speciesName = { 'pine': 'ì†Œë‚˜ë¬´', 'zelkova': 'ëŠí‹°ë‚˜ë¬´', 'ginkgo': 'ì€í–‰ë‚˜ë¬´', 'cherry': 'ë²šë‚˜ë¬´', 'default': 'ê¸°íƒ€' };
        const speciesColor = { 'pine': '#2ecc71', 'zelkova': '#3498db', 'ginkgo': '#f1c40f', 'cherry': '#e91e63', 'default': '#95a5a6' };
        
        let chartData = { species: {}, carbon: {} };
        let allMarkers = []; 
        let currentFilter = null;

        // 1. ë‚˜ë¬´ ë°ì´í„° ë¡œë“œ
        async function loadTreeData() {
            try {
                const response = await fetch('api_trees.php'); 
                const data = await response.json();

                if(data.stats) {
                    document.getElementById('stat-tree-count').innerText = data.stats.total_trees;
                    document.getElementById('stat-carbon').innerText = data.stats.total_carbon;
                    document.getElementById('stat-cars').innerText = data.stats.car_equivalent;
                }

                chartData.species = { 'pine':0, 'zelkova':0, 'ginkgo':0, 'cherry':0, 'default':0 };
                chartData.carbon = { 'pine':0, 'zelkova':0, 'ginkgo':0, 'cherry':0, 'default':0 };
                allMarkers = []; 
                clusterer.clear(); // í´ëŸ¬ìŠ¤í„° ì´ˆê¸°í™”

                const treeImage = new kakao.maps.MarkerImage('https://cdn-icons-png.flaticon.com/512/489/489969.png', new kakao.maps.Size(35, 35), { offset: new kakao.maps.Point(17, 35) });
                var commonInfowindow = new kakao.maps.InfoWindow({ zIndex: 100, removable: true });

                data.features.forEach(feature => {
                    var props = feature.properties;
                    if (!feature.geometry.coordinates || feature.geometry.coordinates.length < 2) return;
                    
                    var lat = feature.geometry.coordinates[1];
                    var lng = feature.geometry.coordinates[0];
                    var markerPosition = new kakao.maps.LatLng(lat, lng);

                    // â˜… [í•µì‹¬ 3] ì¢Œí‘œë¥¼ boundsì— ì¶”ê°€
                    bounds.extend(markerPosition);

                    // í†µê³„ ì§‘ê³„
                    let sp = props.species;
                    if(!chartData.species.hasOwnProperty(sp)) sp = 'default';
                    chartData.species[sp] += parseInt(props.count);
                    chartData.carbon[sp] += parseFloat(props.co2);

                    // íŒì—… ë‚´ìš©
                    var statusColor = props.status === 'healthy' ? '#00c853' : '#ff3d00';
                    var statusText = props.status === 'healthy' ? 'ì–‘í˜¸' : 'ê´€ë¦¬í•„ìš”';
                    var spName = speciesName[props.species] || props.species;
                    var countLabel = props.count > 1 ? ` <span style="font-size:12px; color:#ffeb3b; font-weight:bold;">(x${props.count})</span>` : '';
                    var photoHtml = props.image_path ? `<div style="margin-bottom:8px;"><img src="${props.image_path}" style="width:100%; height:120px; object-fit:cover; border-radius:6px;"></div>` : '';

                    var iwContent = `
                        <div class="iw-container">
                            ${photoHtml}
                            <div class="iw-header"><span>${spName}${countLabel}</span> <span class="iw-status" style="background-color:${statusColor}">${statusText}</span></div>
                            <div class="iw-row"><span>ìˆ˜ëŸ‰</span><span style="font-weight:bold;">${props.count} ê·¸ë£¨</span></div>
                            <div class="iw-row"><span>í‰ê³ ì§ê²½</span><span>${props.dbh} cm</span></div>
                            <div class="iw-carbon-box"><div class="iw-carbon-label">ğŸŒ± ì´ ì—°ê°„ ì´ì‚°í™”íƒ„ì†Œ í¡ìˆ˜ëŸ‰</div><div class="iw-carbon-value">${Number(props.co2).toLocaleString()} kg</div></div>
                        </div>`;

                    var mapObject;

                    if (props.image_path) {
                        var content = document.createElement('div');
                        content.className = 'tree-photo-marker';
                        content.style.backgroundImage = `url('${props.image_path}')`;
                        content.title = spName;
                        
                        mapObject = new kakao.maps.CustomOverlay({ position: markerPosition, content: content, map: map, yAnchor: 0.5 });
                        
                        // CustomOverlayëŠ” í´ëŸ¬ìŠ¤í„°ëŸ¬ì— ë„£ì§€ ì•Šê³  ë³„ë„ ê´€ë¦¬ (ë˜ëŠ” Markerë¡œ ë³€í™˜ í•„ìš”í•˜ì§€ë§Œ ì—¬ê¸°ì„  ê·¸ëƒ¥ ë‘ )
                        content.addEventListener('click', function() {
                            commonInfowindow.setContent(iwContent);
                            commonInfowindow.setPosition(markerPosition);
                            commonInfowindow.open(map);
                        });
                        
                        // ì˜¤ë²„ë ˆì´ëŠ” í´ëŸ¬ìŠ¤í„°ë§ì´ ì•ˆ ë˜ë¯€ë¡œ ê·¸ëƒ¥ ë§µì— í‘œì‹œ
                        allMarkers.push({ obj: mapObject, species: props.species, type: 'overlay' });

                    } else {
                        mapObject = new kakao.maps.Marker({ position: markerPosition, image: treeImage, title: spName });
                        kakao.maps.event.addListener(mapObject, 'click', function() {
                            commonInfowindow.setContent(iwContent);
                            commonInfowindow.open(map, mapObject);
                        });
                        
                        // ë§ˆì»¤ëŠ” í´ëŸ¬ìŠ¤í„°ëŸ¬ì— ì¶”ê°€
                        clusterer.addMarker(mapObject);
                        allMarkers.push({ obj: mapObject, species: props.species, type: 'marker' });
                    }
                });

                updateCharts();

            } catch (error) { console.error('Tree Data Error:', error); }
        }

        // 2. êµ¬ì—­ ë°ì´í„° ë¡œë“œ
        async function loadZoneData() {
            try {
                const response = await fetch('api_zones.php');
                const zones = await response.json();
                zones.forEach(zone => {
                    var geoType = zone.geometry.type;
                    var coords = zone.geometry.coordinates;
                    var props = zone.properties;
                    var overlayPos, overlayObj;

                    if (geoType === 'Polygon') {
                        var path = coords[0].map(c => new kakao.maps.LatLng(c[1], c[0]));
                        overlayObj = new kakao.maps.Polygon({ map: map, path: path, strokeWeight: 2, strokeColor: '#004c80', fillColor: '#00c853', fillOpacity: 0.2 });
                        overlayPos = path[0];
                        // â˜… [í•µì‹¬ 3] êµ¬ì—­ ì¢Œí‘œë„ boundsì— ì¶”ê°€
                        path.forEach(p => bounds.extend(p));

                    } else if (geoType === 'LineString') {
                        var path = coords.map(c => new kakao.maps.LatLng(c[1], c[0]));
                        overlayObj = new kakao.maps.Polyline({ map: map, path: path, strokeWeight: 8, strokeColor: '#8e44ad', strokeOpacity: 0.6 });
                        overlayPos = path[Math.floor(path.length/2)];
                        path.forEach(p => bounds.extend(p));
                    }
                    if(!overlayObj) return;

                    let statsHtml = ''; let stats = props.stats || {};
                    if (Object.keys(stats).length === 0) statsHtml = '<div style="text-align:center; color:#999;">ë°ì´í„° ì—†ìŒ</div>';
                    else for (let [code, count] of Object.entries(stats)) statsHtml += `<div class="zone-stat-row"><span>${speciesName[code]||code}</span><b>${count}ì£¼</b></div>`;
                    
                    var content = `<div class="zone-overlay"><div class="zone-title">ğŸ“ ${props.name}</div><div class="zone-stats">${statsHtml}</div><div class="zone-total">ì´ ${props.total_trees} ê·¸ë£¨</div></div>`;
                    var customOverlay = new kakao.maps.CustomOverlay({ content: content, position: overlayPos, yAnchor: 1.2 });

                    kakao.maps.event.addListener(overlayObj, 'click', () => { if(customOverlay.getMap()) customOverlay.setMap(null); else customOverlay.setMap(map); });
                    kakao.maps.event.addListener(overlayObj, 'mouseover', () => { if(overlayObj.setOptions) overlayObj.setOptions({fillOpacity: 0.5}); else overlayObj.setOptions({strokeOpacity: 1}); });
                    kakao.maps.event.addListener(overlayObj, 'mouseout', () => { if(overlayObj.setOptions) overlayObj.setOptions({fillOpacity: 0.2}); else overlayObj.setOptions({strokeOpacity: 0.6}); });
                });
            } catch (error) { console.error('Zone Error:', error); }
        }

        // 3. ì°¨íŠ¸ ë° í•„í„°ë§
        function toggleChart() {
            var modal = document.getElementById('chartModal');
            modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
        }

        function filterMapBySpecies(speciesCode) {
            currentFilter = speciesCode;
            var statusDiv = document.getElementById('filterStatus');

            if (speciesCode) {
                statusDiv.style.display = 'inline';
                statusDiv.innerText = `âš¡ ${speciesName[speciesCode] || speciesCode}ë§Œ í‘œì‹œ ì¤‘`;
                
                // í´ëŸ¬ìŠ¤í„°ëŸ¬ ì´ˆê¸°í™” í›„ í•„í„°ë§ëœ ë§ˆì»¤ë§Œ ë‹¤ì‹œ ì¶”ê°€
                clusterer.clear();
                
                allMarkers.forEach(item => {
                    if (item.species === speciesCode) {
                        if(item.type === 'marker') clusterer.addMarker(item.obj);
                        else item.obj.setMap(map); // ì˜¤ë²„ë ˆì´ëŠ” ì§ì ‘ í‘œì‹œ
                    } else {
                        if(item.type === 'overlay') item.obj.setMap(null);
                    }
                });
            } else {
                statusDiv.style.display = 'none';
                clusterer.clear();
                allMarkers.forEach(item => {
                    if(item.type === 'marker') clusterer.addMarker(item.obj);
                    else item.obj.setMap(map);
                });
            }
        }

        function updateCharts() {
            const labelOption = { color: '#fff', font: { weight: 'bold', size: 12 }, formatter: (value) => value > 0 ? value.toLocaleString() : '' };

            const ctx1 = document.getElementById('speciesChart').getContext('2d');
            new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(chartData.species).map(k => speciesName[k]),
                    datasets: [{
                        data: Object.values(chartData.species),
                        backgroundColor: Object.keys(chartData.species).map(k => speciesColor[k])
                    }]
                },
                options: { 
                    responsive: true, 
                    plugins: { legend: { position: 'right' }, datalabels: labelOption },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const speciesCode = Object.keys(chartData.species)[elements[0].index];
                            if (currentFilter === speciesCode) filterMapBySpecies(null);
                            else filterMapBySpecies(speciesCode);
                        } else filterMapBySpecies(null);
                    }
                }
            });

            const ctx2 = document.getElementById('carbonChart').getContext('2d');
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: Object.keys(chartData.carbon).map(k => speciesName[k]),
                    datasets: [{
                        label: 'íƒ„ì†Œ í¡ìˆ˜ëŸ‰ (kg)',
                        data: Object.values(chartData.carbon),
                        backgroundColor: '#27ae60'
                    }]
                },
                options: { 
                    responsive: true, scales: { y: { beginAtZero: true } },
                    plugins: { datalabels: { ...labelOption, anchor: 'center', align: 'center' } },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const speciesCode = Object.keys(chartData.carbon)[elements[0].index];
                            if (currentFilter === speciesCode) filterMapBySpecies(null);
                            else filterMapBySpecies(speciesCode);
                        }
                    }
                }
            });
        }

        // â˜… [í•µì‹¬ 4] ëª¨ë“  ë°ì´í„° ë¡œë“œ í›„ ì§€ë„ ë²”ìœ„ ì¬ì„¤ì •
        Promise.all([loadTreeData(), loadZoneData()]).then(() => {
            if (!bounds.isEmpty()) {
                map.setBounds(bounds);
                // ë„ˆë¬´ ì¤Œì•„ì›ƒ ë˜ëŠ” ê²ƒ ë°©ì§€ (ìµœëŒ€ ë ˆë²¨ ì œí•œ, í•„ìš” ì‹œ ì£¼ì„ í•´ì œ)
                // if (map.getLevel() > 10) map.setLevel(10);
            }
        });

        window.addEventListener('resize', function() { map.relayout(); });

    </script>
</body>
</html>