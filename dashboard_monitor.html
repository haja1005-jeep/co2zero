<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ íƒ„ì†Œì¤‘ë¦½ í†µí•© ëª¨ë‹ˆí„°ë§</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script> 
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=257fdd3647dd6abdb05eae8681106514&libraries=services"></script>
    <style>
        body { margin:0; padding:0; background: #f4f6f9; font-family: 'Noto Sans KR', sans-serif; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 24px; color: #2c3e50; }
        .refresh-btn { background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        .kpi-row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .kpi-card { flex: 1; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); min-width: 200px; }
        .kpi-title { font-size: 13px; color: #7f8c8d; margin-bottom: 5px; font-weight: bold; }
        .kpi-value { font-size: 28px; font-weight: bold; color: #2c3e50; }
        .kpi-unit { font-size: 14px; color: #95a5a6; margin-left: 3px; }

        .grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .panel { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .panel-header { font-size: 16px; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #34495e; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; background: #f8f9fa; padding: 10px; color: #555; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        tr:last-child td { border-bottom: none; }
        .rank-badge { background: #f1c40f; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; }

        @media (max-width: 768px) {
            .grid-row { grid-template-columns: 1fr; }
            .kpi-row { gap: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š ìŠ¤ë§ˆíŠ¸ íƒ„ì†Œì¤‘ë¦½ ëª¨ë‹ˆí„°ë§</h1>
        <button class="refresh-btn" onclick="location.reload()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <div class="kpi-row">
        <div class="kpi-card" style="border-left: 5px solid #2ecc71;">
            <div class="kpi-title">ì´ ê´€ë¦¬ ìˆ˜ëª©</div>
            <div><span id="totalTree" class="kpi-value">0</span><span class="kpi-unit">ê·¸ë£¨</span></div>
        </div>
        <div class="kpi-card" style="border-left: 5px solid #3498db;">
            <div class="kpi-title">ì—°ê°„ íƒ„ì†Œ í¡ìˆ˜ëŸ‰</div>
            <div><span id="totalCarbon" class="kpi-value">0</span><span class="kpi-unit">kg/ë…„</span></div>
        </div>
        <div class="kpi-card" style="border-left: 5px solid #9b59b6;">
            <div class="kpi-title">ìŠ¹ìš©ì°¨ ìƒì‡„ íš¨ê³¼</div>
            <div><span id="totalCar" class="kpi-value">0</span><span class="kpi-unit">ëŒ€ ë¶„ëŸ‰</span></div>
        </div>
        <div class="kpi-card" style="border-left: 5px solid #e74c3c;">
            <div class="kpi-title">ë“±ë¡ëœ êµ¬ì—­/ê°€ë¡œìˆ˜ê¸¸</div>
            <div><span id="totalZone" class="kpi-value">0</span><span class="kpi-unit">ê°œì†Œ</span></div>
        </div>
    </div>

    <div class="grid-row">
        <div class="panel">
            <div class="panel-header">ğŸŒ² ìˆ˜ì¢…ë³„ ë¶„í¬ í˜„í™©</div>
            <canvas id="speciesChart" height="250"></canvas>
        </div>
        <div class="panel">
            <div class="panel-header">ğŸ’¨ íƒ„ì†Œ í¡ìˆ˜ ê¸°ì—¬ë„ (Top 5 ìˆ˜ì¢…)</div>
            <canvas id="carbonChart" height="250"></canvas>
        </div>
    </div>

    <div class="grid-row">
        <div class="panel">
            <div class="panel-header">ğŸ† íƒ„ì†Œ í¡ìˆ˜ ìš°ìˆ˜ êµ¬ì—­ (Top 5)</div>
            <table id="zoneRankTable">
                <thead>
                    <tr>
                        <th width="10%">ìˆœìœ„</th>
                        <th>êµ¬ì—­ëª…</th>
                        <th>ì£¼ìš” ìˆ˜ì¢…</th> <th width="15%">ìˆ˜ëª© ìˆ˜</th>
                        <th width="20%">í¡ìˆ˜ëŸ‰(kg)</th>
                    </tr>
                </thead>
                <tbody><tr><td colspan="5" style="text-align:center;">ë¡œë”© ì¤‘...</td></tr></tbody>
            </table>
        </div>
        
        <div class="panel">
            <div class="panel-header">ğŸ©º ìˆ˜ëª© ê±´ê°• ìƒíƒœ</div>
            <canvas id="healthChart" height="200"></canvas>
        </div>
    </div>
</div>

<script>
    // Chart.js ë°ì´í„°ë¼ë²¨ í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
    Chart.register(ChartDataLabels);

    const speciesName = { 'pine': 'ì†Œë‚˜ë¬´', 'zelkova': 'ëŠí‹°ë‚˜ë¬´', 'ginkgo': 'ì€í–‰ë‚˜ë¬´', 'cherry': 'ë²šë‚˜ë¬´', 'default': 'ê¸°íƒ€' };
    const typeName = { 'park': 'ê³µì›', 'street': 'ê°€ë¡œìˆ˜ê¸¸', 'forest': 'ìƒí™œìˆ²', 'zone': 'êµ¬ì—­' };

    async function initDashboard() {
        try {
            const treeRes = await fetch('api_trees.php');
            const treeData = await treeRes.json();
            const zoneRes = await fetch('api_zones.php');
            const zoneData = await zoneRes.json();

            const stats = treeData.stats;
            const features = treeData.features;

            // KPI ì—…ë°ì´íŠ¸
            document.getElementById('totalTree').innerText = stats.total_trees;
            document.getElementById('totalCarbon').innerText = stats.total_carbon;
            document.getElementById('totalCar').innerText = stats.car_equivalent;
            document.getElementById('totalZone').innerText = zoneData.length;

            let spCount = {}, spCarbon = {}, healthCount = {'healthy':0, 'warning':0, 'danger':0, 'dead':0};
            
            features.forEach(f => {
                let p = f.properties;
                let sp = p.species;
                let h = p.status;
                spCount[sp] = (spCount[sp] || 0) + p.count;
                spCarbon[sp] = (spCarbon[sp] || 0) + p.co2;
                healthCount[h] = (healthCount[h] || 0) + p.count;
            });

            // êµ¬ì—­ ë­í‚¹ (ìˆ˜ëŸ‰ ê¸°ì¤€ ì •ë ¬)
            zoneData.sort((a, b) => b.properties.total_trees - a.properties.total_trees);
            
            renderCharts(spCount, spCarbon, healthCount);
            renderZoneTable(zoneData);

        } catch (e) { console.error("ëŒ€ì‹œë³´ë“œ ë¡œë”© ì‹¤íŒ¨", e); }
    }

function renderCharts(spCount, spCarbon, healthCount) {
        // ê³µí†µ ì˜µì…˜: ê¸€ì êµµê²Œ, í°ìƒ‰
        const labelOption = {
            color: '#fff',
            font: { weight: 'bold', size: 14 },
            formatter: (value) => value > 0 ? value.toLocaleString() : '' // 0ì´ë©´ í‘œì‹œ ì•ˆ í•¨, ì²œë‹¨ìœ„ ì½¤ë§ˆ ì¶”ê°€
        };

        // 1. ìˆ˜ì¢…ë³„ ë¶„í¬ (ë„ë„›)
        new Chart(document.getElementById('speciesChart'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(spCount).map(k => speciesName[k] || k),
                datasets: [{
                    data: Object.values(spCount),
                    backgroundColor: ['#2ecc71', '#3498db', '#f1c40f', '#e74c3c', '#95a5a6']
                }]
            },
            options: { 
                responsive: true, 
                plugins: { 
                    legend: { position: 'right' },
                    datalabels: labelOption // ë„ë„› ì°¨íŠ¸ ìˆ«ì (í°ìƒ‰)
                } 
            }
        });

        // 2. íƒ„ì†Œ í¡ìˆ˜ (ë§‰ëŒ€) - [ìˆ˜ì •ë¨]
        new Chart(document.getElementById('carbonChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(spCarbon).map(k => speciesName[k] || k),
                datasets: [{
                    label: 'íƒ„ì†Œ í¡ìˆ˜ëŸ‰ (kg)',
                    data: Object.values(spCarbon),
                    backgroundColor: '#27ae60'
                }]
            },
            options: { 
                responsive: true, 
                scales: { y: { beginAtZero: true } },
                plugins: { 
                    datalabels: { 
                        ...labelOption, 
                        // â˜… ì—¬ê¸°ê°€ í•µì‹¬ ë³€ê²½ ì‚¬í•­ì…ë‹ˆë‹¤ â˜…
                        anchor: 'center', // ë§‰ëŒ€ ì•ˆìª½ ì¤‘ì•™ì— ê³ ì •
                        align: 'center',  // ì¤‘ì•™ ì •ë ¬
                        color: '#fff'     // í°ìƒ‰ í…ìŠ¤íŠ¸
                    } 
                } 
            }
        });

        // 3. ê±´ê°• ìƒíƒœ (íŒŒì´)
        new Chart(document.getElementById('healthChart'), {
            type: 'pie',
            data: {
                labels: ['ì–‘í˜¸', 'ê´€ë¦¬í•„ìš”', 'ìœ„í—˜', 'ê³ ì‚¬'],
                datasets: [{
                    data: [healthCount.healthy, healthCount.warning, healthCount.danger, healthCount.dead],
                    backgroundColor: ['#2ecc71', '#f39c12', '#e74c3c', '#34495e']
                }]
            },
            options: { 
                responsive: true,
                plugins: { datalabels: labelOption }
            }
        });
    }

    function renderZoneTable(zones) {
        const tbody = document.querySelector('#zoneRankTable tbody');
        tbody.innerHTML = '';
        
        zones.slice(0, 5).forEach((z, index) => {
            let p = z.properties;
            
            // â˜… [ì¶”ê°€ëœ ë¡œì§] êµ¬ì—­ ë‚´ ëŒ€í‘œ ìˆ˜ì¢… ì°¾ê¸°
            let maxSpeciesCode = '-';
            let maxCount = 0;
            let stats = p.stats || {};
            
            for (const [code, count] of Object.entries(stats)) {
                if (count > maxCount) {
                    maxCount = count;
                    maxSpeciesCode = code;
                }
            }
            let mainSpecies = maxSpeciesCode !== '-' ? (speciesName[maxSpeciesCode] || maxSpeciesCode) : 'ì •ë³´ì—†ìŒ';
            
            // ì˜ˆìƒ íƒ„ì†Œ í¡ìˆ˜ëŸ‰ (ê°„ì´)
            let estCarbon = (p.total_trees * 10).toLocaleString(); 

            let row = `
                <tr>
                    <td><span class="rank-badge">${index + 1}ìœ„</span></td>
                    <td style="font-weight:bold;">${p.name}</td>
                    <td style="color:#555;">ğŸŒ² ${mainSpecies}</td> <td style="color:#2980b9; font-weight:bold;">${p.total_trees}ì£¼</td>
                    <td style="color:#27ae60;">ì•½ ${estCarbon}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    initDashboard();
</script>

</body>
</html>