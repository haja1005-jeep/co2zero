<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ì¹´ì˜¤ë§µ + ë¸Œì´ì›”ë“œ ì§€ì ë„ + ê¸¸ì°¾ê¸°</title>
    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100%; height: 100vh; }
        .loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 999; background: rgba(0,0,0,0.7); color: white;
            padding: 10px 20px; border-radius: 5px; display: none;
        }
        .error-msg {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: #ff4444; color: white;
            padding: 10px 20px; border-radius: 5px; display: none;
            max-width: 80%;
        }
        .success-msg {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: #28a745; color: white;
            padding: 10px 20px; border-radius: 5px; display: none;
            max-width: 80%;
        }
        .info-msg {
            position: absolute; top: 10px; right: 10px;
            z-index: 1000; background: rgba(0,0,0,0.7); color: white;
            padding: 10px; border-radius: 5px; font-size: 12px;
        }
        .search-box {
            position: absolute; top: 10px; left: 10px;
            z-index: 1000; background: white;
            padding: 15px; border-radius: 5px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            max-width: 380px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .search-box input {
            padding: 8px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
            margin-bottom: 8px;
            box-sizing: border-box;
        }
        .search-box button {
            padding: 8px 15px;
            background: #004c80;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
            margin-top: 5px;
            font-size: 13px;
        }
        .search-box button:hover {
            background: #003d66;
        }
        .search-box button.danger {
            background: #dc3545;
        }
        .search-box button.danger:hover {
            background: #c82333;
        }
        .search-box button.success {
            background: #28a745;
        }
        .search-box button.success:hover {
            background: #218838;
        }
        .search-box button.secondary {
            background: #6c757d;
        }
        .search-box button.secondary:hover {
            background: #5a6268;
        }
        .section-title {
            font-weight: bold;
            margin-top: 10px;
            margin-bottom: 5px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            color: #333;
        }
        .section-title:first-child {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }
        .custom-overlay {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 13px;
            white-space: nowrap;
            pointer-events: none;
            transform: translate(-50%, -100%);
            margin-top: -10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1001;
        }
        .custom-overlay::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid rgba(0, 0, 0, 0.85);
        }
        .route-info {
            background: rgba(255,255,255,0.95);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 13px;
            line-height: 1.6;
        }
        .mode-indicator {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 13px;
            color: #856404;
            text-align: center;
            font-weight: bold;
        }
        .location-btn {
            position: absolute;
            bottom: 100px;
            right: 10px;
            z-index: 1000;
            background: white;
            border: 2px solid #004c80;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .location-btn:hover {
            background: #f0f0f0;
        }
        .location-btn:active {
            background: #e0e0e0;
        }
    </style>
</head>
<body>

<div class="search-box">
    <div class="section-title">ğŸ” ì§€ì ë„ ê²€ìƒ‰</div>
    <input type="text" id="searchJibun" placeholder="ì˜ˆ: ì „ë¼ë‚¨ë„ ëª©í¬ì‹œ ìš©ë‹¹ë™ 183-42" value="ì „ë¼ë‚¨ë„ ëª©í¬ì‹œ ìš©ë‹¹ë™ 183-42">
    <button onclick="searchSpecificJibun()">ì§€ë²ˆ ê²€ìƒ‰</button>
    <button onclick="showAllJibun()">ì „ì²´ë³´ê¸°</button>
    
    <div class="section-title">ğŸš— ê¸¸ì°¾ê¸°</div>
    <div id="modeIndicator" class="mode-indicator" style="display:none;">
        ğŸ“ ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ <span id="modeText">ì¶œë°œì§€</span>ë¥¼ ì„¤ì •í•˜ì„¸ìš”
    </div>
    <input type="text" id="startAddress" placeholder="ì¶œë°œì§€ ì£¼ì†Œ (ë˜ëŠ” ì§€ë„ì—ì„œ í´ë¦­)" readonly>
    <input type="text" id="endAddress" placeholder="ë„ì°©ì§€ ì£¼ì†Œ (ë˜ëŠ” ì§€ë„ì—ì„œ í´ë¦­)" readonly>
    <div>
        <button class="success" onclick="setMarkerMode('start')">ğŸ“ ì¶œë°œ ë§ˆì»¤</button>
        <button class="success" onclick="setMarkerMode('end')">ğŸ¯ ë„ì°© ë§ˆì»¤</button>
    </div>
    <div style="margin-top: 8px;">
        <button onclick="findRoute()">ê²½ë¡œ ì°¾ê¸°</button>
        <button class="danger" onclick="clearRoute()">ê²½ë¡œ ì§€ìš°ê¸°</button>
        <button class="secondary" onclick="clearMarkers()">ë§ˆì»¤ ì§€ìš°ê¸°</button>
    </div>
    
    <div id="routeInfo" class="route-info" style="display:none;"></div>
</div>

<button class="location-btn" onclick="getCurrentLocation()" title="í˜„ì¬ ìœ„ì¹˜">ğŸ“</button>

<div id="loading" class="loading">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
<div id="error" class="error-msg"></div>
<div id="success" class="success-msg"></div>
<div class="info-msg">
    ì¤Œ ë ˆë²¨: <span id="zoomLevel">1</span><br>
    í‘œì‹œëœ í•„ì§€: <span id="polygonCount">0</span>ê°œ
</div>
<div id="map"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=257fdd3647dd6abdb05eae8681106514&libraries=clusterer,services"></script>
  
<script>
    // ==========================================
    // 1. ì„¤ì •ê°’
    // ==========================================
    const VWORLD_KEY = 'ACEB012E-C384-3176-BC45-4D4CAE466B1E';
    const KAKAO_REST_API_KEY = '9bca2b309d1524cada7d463c408e256e';
    const MAX_ZOOM_LEVEL = 5;
    let isLoading = false;
    let filterJibun = null;
    
    // ë§ˆì»¤ ëª¨ë“œ ('start', 'end', null)
    let markerMode = null;
    
    // ==========================================
    // 2. ì§€ë„ ì´ˆê¸°í™”
    // ==========================================
    var mapContainer = document.getElementById('map');
    var mapOption = { 
        center: new kakao.maps.LatLng(34.8118, 126.4057), 
        level: 1
    };
    var map = new kakao.maps.Map(mapContainer, mapOption);

    var polygons = [];
    var currentInfowindow = null;
    var targetMarker = null;
    var hoverOverlay = null;
    
    // ê¸¸ì°¾ê¸° ê´€ë ¨ ë³€ìˆ˜
    var routePolyline = null;
    var startMarker = null;
    var endMarker = null;
    var startCoords = null;
    var endCoords = null;
    var currentLocationMarker = null;

    document.getElementById('zoomLevel').textContent = map.getLevel();

    // ==========================================
    // 3. ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡
    // ==========================================
    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        if (markerMode) {
            const latlng = mouseEvent.latLng;
            const lat = latlng.getLat();
            const lng = latlng.getLng();
            
            // ì£¼ì†Œ ê²€ìƒ‰ (ì¢Œí‘œ -> ì£¼ì†Œ)
            const geocoder = new kakao.maps.services.Geocoder();
            geocoder.coord2Address(lng, lat, function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    const address = result[0].address.address_name;
                    
                    if (markerMode === 'start') {
                        setStartMarker(lat, lng, address);
                    } else if (markerMode === 'end') {
                        setEndMarker(lat, lng, address);
                    }
                } else {
                    if (markerMode === 'start') {
                        setStartMarker(lat, lng, `ìœ„ë„: ${lat.toFixed(6)}, ê²½ë„: ${lng.toFixed(6)}`);
                    } else if (markerMode === 'end') {
                        setEndMarker(lat, lng, `ìœ„ë„: ${lat.toFixed(6)}, ê²½ë„: ${lng.toFixed(6)}`);
                    }
                }
            });
        }
    });

    // ==========================================
    // 4. ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    // ==========================================
    function showError(message) {
        const errorDiv = $('#error');
        errorDiv.html(message).fadeIn();
        setTimeout(() => errorDiv.fadeOut(), 5000);
    }

    function showSuccess(message) {
        const successDiv = $('#success');
        successDiv.html(message).fadeIn();
        setTimeout(() => successDiv.fadeOut(), 3000);
    }

    // ==========================================
    // 5. ë§ˆì»¤ ëª¨ë“œ ì„¤ì •
    // ==========================================
    function setMarkerMode(mode) {
        markerMode = mode;
        const modeText = mode === 'start' ? 'ì¶œë°œì§€' : 'ë„ì°©ì§€';
        $('#modeIndicator').show();
        $('#modeText').text(modeText);
        showSuccess(`ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ${modeText}ë¥¼ ì„¤ì •í•˜ì„¸ìš”`);
    }

    // ==========================================
    // 6. ì¶œë°œì§€ ë§ˆì»¤ ì„¤ì •
    // ==========================================
    function setStartMarker(lat, lng, address) {
        // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
        if (startMarker) {
            startMarker.setMap(null);
        }
        
        startCoords = { lat: lat, lng: lng };
        
        startMarker = new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(lat, lng),
            image: new kakao.maps.MarkerImage(
                'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/red_b.png',
                new kakao.maps.Size(50, 45),
                { offset: new kakao.maps.Point(15, 43) }
            )
        });
        
        $('#startAddress').val(address);
        showSuccess('âœ… ì¶œë°œì§€ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
        markerMode = null;
        $('#modeIndicator').hide();
    }

    // ==========================================
    // 7. ë„ì°©ì§€ ë§ˆì»¤ ì„¤ì •
    // ==========================================
    function setEndMarker(lat, lng, address) {
        // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
        if (endMarker) {
            endMarker.setMap(null);
        }
        
        endCoords = { lat: lat, lng: lng };
        
        endMarker = new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(lat, lng),
            image: new kakao.maps.MarkerImage(
                'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/blue_b.png',
                new kakao.maps.Size(50, 45),
                { offset: new kakao.maps.Point(15, 43) }
            )
        });
        
        $('#endAddress').val(address);
        showSuccess('âœ… ë„ì°©ì§€ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
        markerMode = null;
        $('#modeIndicator').hide();
    }

    // ==========================================
    // 8. ë§ˆì»¤ ì§€ìš°ê¸°
    // ==========================================
    function clearMarkers() {
        if (startMarker) {
            startMarker.setMap(null);
            startMarker = null;
            startCoords = null;
        }
        if (endMarker) {
            endMarker.setMap(null);
            endMarker = null;
            endCoords = null;
        }
        $('#startAddress').val('');
        $('#endAddress').val('');
        markerMode = null;
        $('#modeIndicator').hide();
        showSuccess('ë§ˆì»¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    // ==========================================
    // 9. í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
    // ==========================================
    function getCurrentLocation() {
        if (!navigator.geolocation) {
            showError('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            return;
        }

        $('#loading').show();
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                $('#loading').hide();
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // ì§€ë„ ì´ë™
                const moveLatLon = new kakao.maps.LatLng(lat, lng);
                map.setCenter(moveLatLon);
                map.setLevel(3);
                
                // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ
                if (currentLocationMarker) {
                    currentLocationMarker.setMap(null);
                }
                
                currentLocationMarker = new kakao.maps.Marker({
                    map: map,
                    position: moveLatLon,
                    image: new kakao.maps.MarkerImage(
                        'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png',
                        new kakao.maps.Size(36, 37),
                        { offset: new kakao.maps.Point(18, 37) }
                    )
                });
                
                // ì£¼ì†Œ ê²€ìƒ‰
                const geocoder = new kakao.maps.services.Geocoder();
                geocoder.coord2Address(lng, lat, function(result, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        const address = result[0].address.address_name;
                        showSuccess(`í˜„ì¬ ìœ„ì¹˜: ${address}`);
                    } else {
                        showSuccess(`í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤`);
                    }
                });
                
                getData();
            },
            function(error) {
                $('#loading').hide();
                let errorMsg = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg = 'ìœ„ì¹˜ ì •ë³´ ì•¡ì„¸ìŠ¤ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                        break;
                    case error.TIMEOUT:
                        errorMsg = 'ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.';
                        break;
                }
                showError(errorMsg);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }

    // ==========================================
    // 10. íŠ¹ì • ì§€ë²ˆ ê²€ìƒ‰
    // ==========================================
    function searchSpecificJibun() {
        const input = document.getElementById('searchJibun').value.trim();
        if (!input) {
            showError("ì§€ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        const parts = input.split(' ');
        filterJibun = parts[parts.length - 1];
        
        const geocoder = new kakao.maps.services.Geocoder();
        geocoder.addressSearch(input, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                map.setCenter(coords);
                map.setLevel(1);
                
                if (targetMarker) {
                    targetMarker.setMap(null);
                }
                targetMarker = new kakao.maps.Marker({
                    map: map,
                    position: coords
                });
                
                getData();
            } else {
                showError("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        });
    }

    // ==========================================
    // 11. ì „ì²´ ë³´ê¸°
    // ==========================================
    function showAllJibun() {
        filterJibun = null;
        if (targetMarker) {
            targetMarker.setMap(null);
            targetMarker = null;
        }
        getData();
    }

    // ==========================================
    // 12. ê¸¸ì°¾ê¸° - ê²½ë¡œ ì°¾ê¸°
    // ==========================================
    function findRoute() {
        if (!startCoords || !endCoords) {
            showError("ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ ëª¨ë‘ ì„¤ì •í•´ì£¼ì„¸ìš”.");
            return;
        }

        $('#loading').show();
        
        const startAddr = $('#startAddress').val();
        const endAddr = $('#endAddress').val();
        
        getRouteFromKakao(startCoords, endCoords, startAddr, endAddr);
    }

    // ==========================================
    // 13. ì¹´ì¹´ì˜¤ ê¸¸ì°¾ê¸° API í˜¸ì¶œ
    // ==========================================
    function getRouteFromKakao(start, end, startAddr, endAddr) {
        $.ajax({
            url: 'https://apis-navi.kakaomobility.com/v1/directions',
            type: 'GET',
            headers: {
                'Authorization': `KakaoAK ${KAKAO_REST_API_KEY}`
            },
            data: {
                origin: `${start.lng},${start.lat}`,
                destination: `${end.lng},${end.lat}`,
                priority: 'RECOMMEND',
                car_fuel: 'GASOLINE',
                car_hipass: false,
                alternatives: false,
                road_details: false
            },
            success: function(data) {
                $('#loading').hide();
                drawRoute(data, start, end, startAddr, endAddr);
            },
            error: function(xhr, status, error) {
                $('#loading').hide();
                console.error("ê¸¸ì°¾ê¸° ì˜¤ë¥˜:", error);
                showError("ì¹´ì¹´ì˜¤ ê¸¸ì°¾ê¸° APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§ì„  ê²½ë¡œë¡œ í‘œì‹œí•©ë‹ˆë‹¤.");
                drawStraightRoute(start, end, startAddr, endAddr);
            }
        });
    }

    // ==========================================
    // 14. ê²½ë¡œ ê·¸ë¦¬ê¸°
    // ==========================================
    function drawRoute(data, start, end, startAddr, endAddr) {
        // ê¸°ì¡´ ê²½ë¡œ ì œê±° (ë§ˆì»¤ëŠ” ìœ ì§€)
        if (routePolyline) {
            routePolyline.setMap(null);
        }
        
        if (!data.routes || data.routes.length === 0) {
            showError("ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const route = data.routes[0];
        const path = [];
        
        route.sections.forEach(section => {
            section.roads.forEach(road => {
                road.vertexes.forEach((vertex, index) => {
                    if (index % 2 === 0) {
                        const lng = vertex;
                        const lat = road.vertexes[index + 1];
                        path.push(new kakao.maps.LatLng(lat, lng));
                    }
                });
            });
        });

        routePolyline = new kakao.maps.Polyline({
            map: map,
            path: path,
            strokeWeight: 6,
            strokeColor: '#FF0000',
            strokeOpacity: 0.8,
            strokeStyle: 'solid'
        });

        const distance = (route.summary.distance / 1000).toFixed(1);
        const duration = Math.round(route.summary.duration / 60);
        const fare = route.summary.fare ? route.summary.fare.taxi.toLocaleString() + 'ì›' : 'ì •ë³´ì—†ìŒ';
        
        $('#routeInfo').html(`
            <strong>ğŸ“ ì¶œë°œ:</strong> ${startAddr}<br>
            <strong>ğŸ¯ ë„ì°©:</strong> ${endAddr}<br>
            <strong>ğŸ“ ê±°ë¦¬:</strong> ${distance}km<br>
            <strong>â±ï¸ ì†Œìš”ì‹œê°„:</strong> ì•½ ${duration}ë¶„<br>
            <strong>ğŸš• ì˜ˆìƒ íƒì‹œë¹„:</strong> ${fare}
        `).fadeIn();

        const bounds = new kakao.maps.LatLngBounds();
        path.forEach(point => bounds.extend(point));
        map.setBounds(bounds);
        
        showSuccess('ê²½ë¡œê°€ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    // ==========================================
    // 15. ì§ì„  ê²½ë¡œ ê·¸ë¦¬ê¸°
    // ==========================================
    function drawStraightRoute(start, end, startAddr, endAddr) {
        if (routePolyline) {
            routePolyline.setMap(null);
        }
        
        const path = [
            new kakao.maps.LatLng(start.lat, start.lng),
            new kakao.maps.LatLng(end.lat, end.lng)
        ];

        routePolyline = new kakao.maps.Polyline({
            map: map,
            path: path,
            strokeWeight: 6,
            strokeColor: '#FF0000',
            strokeOpacity: 0.8,
            strokeStyle: 'solid'
        });

        const distance = getDistance(start.lat, start.lng, end.lat, end.lng);
        
        $('#routeInfo').html(`
            <strong>ğŸ“ ì¶œë°œ:</strong> ${startAddr}<br>
            <strong>ğŸ¯ ë„ì°©:</strong> ${endAddr}<br>
            <strong>ğŸ“ ì§ì„ ê±°ë¦¬:</strong> ${distance}km<br>
            <em style="color:#999;">â€» ì§ì„  ê²½ë¡œë¡œ í‘œì‹œë©ë‹ˆë‹¤.</em>
        `).fadeIn();

        const bounds = new kakao.maps.LatLngBounds();
        path.forEach(point => bounds.extend(point));
        map.setBounds(bounds);
    }

    function getDistance(lat1, lng1, lat2, lng2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return (R * c).toFixed(1);
    }

    // ==========================================
    // 16. ê²½ë¡œ ì§€ìš°ê¸°
    // ==========================================
    function clearRoute() {
        if (routePolyline) {
            routePolyline.setMap(null);
            routePolyline = null;
        }
        $('#routeInfo').fadeOut();
        showSuccess('ê²½ë¡œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    // ==========================================
    // 17. ë¸Œì´ì›”ë“œ ë°ì´í„° ìš”ì²­ (ì´í•˜ ë™ì¼)
    // ==========================================
    function getData() {
        const currentLevel = map.getLevel();
        document.getElementById('zoomLevel').textContent = currentLevel;

        if (currentLevel > MAX_ZOOM_LEVEL) {
            removePolygons();
            return;
        }

        if (isLoading) {
            return;
        }

        isLoading = true;
        $('#loading').show();

        var bounds = map.getBounds();
        var sw = bounds.getSouthWest();
        var ne = bounds.getNorthEast();
        var bbox = `${sw.getLng()},${sw.getLat()},${ne.getLng()},${ne.getLat()}`;

        const params = {
            service: 'WFS',
            version: '2.0.0',
            request: 'GetFeature',
            typeName: 'lp_pa_cbnd_bubun',
            srsName: 'EPSG:4326',
            bbox: bbox,
            output: 'text/javascript',
            format_options: 'callback:parseData',
            exceptions: 'text/javascript',
            key: VWORLD_KEY
        };

        const url = "https://api.vworld.kr/req/wfs?" + $.param(params);
        const script = document.createElement('script');
        script.src = url;
        script.id = 'vworld-script';
        
        script.onerror = function() {
            $('#loading').hide();
            isLoading = false;
            if (document.getElementById('vworld-script')) {
                document.head.removeChild(script);
            }
        };

        const oldScript = document.getElementById('vworld-script');
        if (oldScript) {
            document.head.removeChild(oldScript);
        }

        document.head.appendChild(script);
    }

    window.parseData = function(data) {
        $('#loading').hide();
        isLoading = false;

        const script = document.getElementById('vworld-script');
        if (script) {
            document.head.removeChild(script);
        }

        processData(data);
    };

    function processData(data) {
        removePolygons();

        if (data.type === 'error' || data.error) {
            return;
        }

        let features = data.features;
        
        if (!features) {
            if (data.response && data.response.result) {
                features = data.response.result.featureCollection.features;
            } else if (data.result) {
                features = data.result.featureCollection.features;
            } else if (data.featureCollection) {
                features = data.featureCollection.features;
            }
        }

        if (!features || features.length === 0) {
            document.getElementById('polygonCount').textContent = '0';
            return;
        }

        let successCount = 0;
        features.forEach(function(feature) {
            try {
                var geometry = feature.geometry;
                var props = feature.properties;
                
                if (!geometry || !geometry.coordinates) {
                    return;
                }

                if (filterJibun) {
                    const jibun = props.jibun || props.JIBUN || props.addr || props.ADDR || '';
                    if (!jibun.includes(filterJibun)) {
                        return;
                    }
                }

                if (geometry.type === 'Polygon') {
                    drawPolygon(geometry.coordinates[0], props, filterJibun !== null);
                    successCount++;
                } else if (geometry.type === 'MultiPolygon') {
                    geometry.coordinates.forEach(function(coords) {
                        drawPolygon(coords[0], props, filterJibun !== null);
                        successCount++;
                    });
                }
            } catch (e) {
                console.error("ì²˜ë¦¬ ì˜¤ë¥˜:", e);
            }
        });

        document.getElementById('polygonCount').textContent = successCount;
    }

    function drawPolygon(rawPath, props, isHighlight) {
        if (!rawPath || rawPath.length < 3) {
            return;
        }

        var path = [];
        for (var i = 0; i < rawPath.length; i++) {
            if (rawPath[i] && rawPath[i].length >= 2) {
                path.push(new kakao.maps.LatLng(rawPath[i][1], rawPath[i][0]));
            }
        }

        if (path.length < 3) {
            return;
        }

        var polygon = new kakao.maps.Polygon({
            map: map,
            path: path,
            strokeWeight: isHighlight ? 4 : 2,
            strokeColor: isHighlight ? '#ff0000' : '#004c80',
            strokeOpacity: 0.8,
            fillColor: isHighlight ? '#ff0000' : '#fff',
            fillOpacity: isHighlight ? 0.3 : 0.1
        });

        const jibun = props.jibun || props.JIBUN || props.addr || props.ADDR || 'ì •ë³´ì—†ìŒ';
        let area = props.area || props.AREA || props.jimok_area || props.JIMOK_AREA || 
                   props.parea || props.PAREA || props.geom_area || props.GEOM_AREA || '';
        
        if (area && !isNaN(area)) {
            area = parseFloat(area).toLocaleString() + 'ã¡';
        } else if (!area) {
            area = 'ì •ë³´ì—†ìŒ';
        }

        kakao.maps.event.addListener(polygon, 'mouseover', function(mouseEvent) {
            polygon.setOptions({
                fillColor: '#09f',
                fillOpacity: 0.5,
                strokeWeight: isHighlight ? 5 : 3
            });

            if (hoverOverlay) {
                hoverOverlay.setMap(null);
            }

            const content = `
                <div class="custom-overlay">
                    <strong>ì§€ë²ˆ:</strong> ${jibun}<br>
                    <strong>ë©´ì :</strong> ${area}
                </div>
            `;

            hoverOverlay = new kakao.maps.CustomOverlay({
                position: mouseEvent.latLng,
                content: content,
                yAnchor: 1
            });

            hoverOverlay.setMap(map);
        });

        kakao.maps.event.addListener(polygon, 'mouseout', function() {
            polygon.setOptions({
                fillColor: isHighlight ? '#ff0000' : '#fff',
                fillOpacity: isHighlight ? 0.3 : 0.1,
                strokeWeight: isHighlight ? 4 : 2
            });

            if (hoverOverlay) {
                hoverOverlay.setMap(null);
                hoverOverlay = null;
            }
        });

        kakao.maps.event.addListener(polygon, 'click', function() {
            if (hoverOverlay) {
                hoverOverlay.setMap(null);
                hoverOverlay = null;
            }

            if (currentInfowindow) {
                currentInfowindow.close();
            }

            const pnu = props.pnu || props.PNU || '';
            var content = `
                <div style="padding:10px; min-width:180px;">
                    <strong style="color: ${isHighlight ? '#ff0000' : '#004c80'};">ì§€ë²ˆ:</strong> ${jibun}<br>
                    <strong>ë©´ì :</strong> ${area}<br>
                    ${pnu ? '<strong>PNU:</strong> ' + pnu + '<br>' : ''}
                    ${isHighlight ? '<span style="color: #ff0000;">â˜… ê²€ìƒ‰ëœ ì§€ë²ˆ</span>' : ''}
                </div>
            `;
            
            currentInfowindow = new kakao.maps.InfoWindow({
                position: path[0],
                content: content,
                removable: true
            });
            
            currentInfowindow.open(map);
        });

        if (isHighlight && polygons.length === 0) {
            const pnu = props.pnu || props.PNU || '';
            var content = `
                <div style="padding:10px; min-width:180px;">
                    <strong style="color: #ff0000;">ì§€ë²ˆ:</strong> ${jibun}<br>
                    <strong>ë©´ì :</strong> ${area}<br>
                    ${pnu ? '<strong>PNU:</strong> ' + pnu + '<br>' : ''}
                    <span style="color: #ff0000;">â˜… ê²€ìƒ‰ëœ ì§€ë²ˆ</span>
                </div>
            `;
            
            currentInfowindow = new kakao.maps.InfoWindow({
                position: path[0],
                content: content,
                removable: true
            });
            
            currentInfowindow.open(map);
        }

        polygons.push(polygon);
    }

    function removePolygons() {
        for (var i = 0; i < polygons.length; i++) {
            polygons[i].setMap(null);
        }
        polygons = [];
        
        if (currentInfowindow) {
            currentInfowindow.close();
            currentInfowindow = null;
        }

        if (hoverOverlay) {
            hoverOverlay.setMap(null);
            hoverOverlay = null;
        }
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    const debouncedGetData = debounce(getData, 800);

    kakao.maps.event.addListener(map, 'dragend', debouncedGetData);
    kakao.maps.event.addListener(map, 'zoom_changed', function() {
        document.getElementById('zoomLevel').textContent = map.getLevel();
        debouncedGetData();
    });

    document.getElementById('searchJibun').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchSpecificJibun();
        }
    });

    console.log("=== ì´ˆê¸°í™” ì™„ë£Œ ===");
    getData(); 

</script>
</body>
</html>